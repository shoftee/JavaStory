package tools;

import java.awt.Point;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.Comparator;
import java.util.List;
import java.util.LinkedHashMap;
import java.util.Map;
import java.util.Map.Entry;
import java.sql.ResultSet;
import java.sql.SQLException;

import client.MapleMount;
import client.BuddylistEntry;
import client.IEquip;
import client.IItem;
import client.Item;
import client.GameConstants;
import client.MapleBuffStat;
import client.MapleCharacter;
import client.MapleClient;
import client.MapleInventory;
import client.MapleInventoryType;
import client.MapleKeyLayout;
import client.MaplePet;
import client.MapleQuestStatus;
import client.MapleStat;
import client.IEquip.ScrollResult;
import client.MapleDisease;
import client.MapleRing;
import client.SkillMacro;
import handling.ByteArrayMaplePacket;
import handling.MaplePacket;
import handling.ServerPacketOpcode;
import handling.ServerConstants;
import handling.world.MapleParty;
import handling.world.MaplePartyCharacter;
import handling.world.PartyOperation;
import handling.world.guild.MapleGuild;
import handling.world.guild.MapleGuildSummary;
import handling.world.guild.MapleGuildCharacter;
import handling.world.guild.MapleAlliance;
import handling.channel.GuildRankingInfo;
import server.MapleItemInformationProvider;
import server.MapleShopItem;
import server.MapleStatEffect;
import server.MapleTrade;
import server.MapleDueyActions;
import server.Randomizer;
import server.life.MobSkill;
import server.life.SummonAttackEntry;
import server.maps.MapleSummon;
import server.life.MapleNPC;
import server.life.MapleNPCStats;
import server.maps.MapleDragon;
import server.maps.MapleMap;
import server.maps.MapleReactor;
import server.maps.MapleMist;
import server.maps.MapleMapItem;
import server.movement.LifeMovementFragment;
import tools.data.output.LittleEndianWriter;
import tools.data.output.MaplePacketLittleEndianWriter;
import tools.packet.PacketHelper;

public class MaplePacketCreator {

	private final static byte[] CHAR_INFO_MAGIC = new byte[]{(byte) 0xFF, (byte) 0xC9, (byte) 0x9A, 0x3B};
	public final static List<Pair<MapleStat, Integer>> EMPTY_STATUPDATE = Collections.emptyList();

	public static final MaplePacket getServerIP(final int port, final int clientId) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SERVER_IP.getValue());
		mplew.writeShort(0);
		mplew.write(ServerConstants.Server_IP);
		mplew.writeShort(port);
		mplew.writeInt(clientId);
		mplew.writeZeroBytes(5);

		return mplew.getPacket();
	}

	public static final MaplePacket getChannelChange(final int port) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CHANGE_CHANNEL.getValue());
		mplew.write(1);
		mplew.write(ServerConstants.Server_IP);
		mplew.writeShort(port);

		return mplew.getPacket();
	}

	public static final MaplePacket getCharInfo(final MapleCharacter chr) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.WARP_TO_MAP.getValue());
		mplew.writeLong(chr.getClient().getChannel() - 1);
		mplew.write(1);
		mplew.write(1);
		mplew.writeZeroBytes(2);
		chr.CRand().connectData(mplew); // Random number generator
		mplew.writeLong(-1);
		mplew.write(0);
		PacketHelper.addCharStats(mplew, chr);
		mplew.write(chr.getBuddylist().getCapacity());
		if (chr.getBlessOfFairyOrigin() != null) {
			mplew.write(1);
			mplew.writeMapleAsciiString(chr.getBlessOfFairyOrigin());
		} else {
			mplew.write(0);
		}
		PacketHelper.addInventoryInfo(mplew, chr);
		PacketHelper.addSkillInfo(mplew, chr);
		PacketHelper.addCoolDownInfo(mplew, chr);
		PacketHelper.addQuestInfo(mplew, chr);
		PacketHelper.addRingInfo(mplew, chr);
		PacketHelper.addRocksInfo(mplew, chr);
		PacketHelper.addMonsterBookInfo(mplew, chr);
		chr.QuestInfoPacket(mplew); // for every questinfo: int16_t questid, string questdata
		mplew.writeShort(0); // PQ rank
		mplew.writeLong(PacketHelper.getTime(System.currentTimeMillis()));

		return mplew.getPacket();
	}

	public static final MaplePacket enableActions() {
		return updatePlayerStats(EMPTY_STATUPDATE, true, 0);
	}

	public static final MaplePacket updatePlayerStats(final List<Pair<MapleStat, Integer>> stats, final int evan) {
		return updatePlayerStats(stats, false, evan);
	}

	public static final MaplePacket updatePlayerStats(final List<Pair<MapleStat, Integer>> stats, final boolean itemReaction, final int evan) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.UPDATE_STATS.getValue());
		mplew.write(itemReaction ? 1 : 0);
		int updateMask = 0;
		for (final Pair<MapleStat, Integer> statupdate : stats) {
		updateMask |= statupdate.getLeft().getValue();
		}
		List<Pair<MapleStat, Integer>> mystats = stats;
		if (mystats.size() > 1) {
		Collections.sort(mystats, new Comparator<Pair<MapleStat, Integer>>() {
		@Override
		public int compare(final Pair<MapleStat, Integer> o1, final Pair<MapleStat, Integer> o2) {
		int val1 = o1.getLeft().getValue();
		int val2 = o2.getLeft().getValue();
		return (val1 < val2 ? -1 : (val1 == val2 ? 0 : 1));
		}
		});
		}
		mplew.writeInt(updateMask);
		Integer value;
		for (final Pair<MapleStat, Integer> statupdate : mystats) {
		value = statupdate.getLeft().getValue();
		if (value >= 1) {
		if (value == 0x1) {
		mplew.writeShort(statupdate.getRight().shortValue());
		} else if (value <= 0x4) {
		mplew.writeInt(statupdate.getRight());
		} else if (value < 0x20) {
		mplew.write(statupdate.getRight().byteValue());
		} else if (value == 0x8000) { //availablesp
		if (evan == 2001 || (evan >= 2200 && evan <= 2218)) {
		throw new UnsupportedOperationException("Evan wrong updating");
		} else {
		mplew.writeShort(statupdate.getRight().shortValue());
		}
		} else if (value < 0xFFFF) {
		mplew.writeShort(statupdate.getRight().shortValue());
		} else {
		mplew.writeInt(statupdate.getRight().intValue());
		}
		}
		}
		return mplew.getPacket();
	}

	public static final MaplePacket updateSp(MapleCharacter chr, final boolean itemReaction) { //this will do..
	return updateSp(chr, itemReaction, false);
	}

	public static final MaplePacket updateSp(MapleCharacter chr, final boolean itemReaction, final boolean overrideJob) { //this will do..
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();
	mplew.writeShort(ServerPacketOpcode.UPDATE_STATS.getValue());
	mplew.write(itemReaction ? 1 : 0);
	mplew.writeInt(0x8000);
	if (overrideJob || GameConstants.isEvan(chr.getJob())) {
	mplew.write(chr.getRemainingSpSize());
	for (int i = 0; i < chr.getRemainingSps().length; i++) {
	if (chr.getRemainingSp(i) > 0) {
	mplew.write(i + 1);
	mplew.write(chr.getRemainingSp(i));
	}
	}
	} else {
	mplew.writeShort(chr.getRemainingSp());
	}
	return mplew.getPacket();

	}

	public static final MaplePacket getWarpToMap(final MapleMap to, final int spawnPoint, final MapleCharacter chr) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.WARP_TO_MAP.getValue());
		mplew.writeLong(chr.getClient().getChannel() - 1);
		mplew.writeInt(0x2); // count
		mplew.write(0);
		mplew.writeInt(to.getId());
		mplew.write(spawnPoint);
		mplew.writeShort(chr.getStat().getHp());
		mplew.write(0);
		mplew.writeLong(PacketHelper.getTime(System.currentTimeMillis()));

		return mplew.getPacket();
	}

	public static final MaplePacket instantMapWarp(final byte portal) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CURRENT_MAP_WARP.getValue());
		mplew.write(0);
		mplew.write(portal); // 6

		return mplew.getPacket();
	}

	public static final MaplePacket spawnPortal(final int townId, final int targetId, final Point pos) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SPAWN_PORTAL.getValue());
		mplew.writeInt(townId);
		mplew.writeInt(targetId);
		mplew.write(2311002);
		if (pos != null) {
			mplew.writePos(pos);
		}

		return mplew.getPacket();
	}

	public static final MaplePacket spawnDoor(final int oid, final Point pos, final boolean town) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_DOOR.getValue());
	mplew.write(/*town ? 1 :*/0);
	mplew.write(town ? 1 : 0);
	mplew.writeInt(oid);
	mplew.writePos(pos);

	return mplew.getPacket();
	}

	public static MaplePacket removeDoor(int oid, boolean town) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	if (town) {
	mplew.writeShort(ServerPacketOpcode.SPAWN_PORTAL.getValue());
	mplew.writeInt(999999999);
	mplew.writeLong(999999999);
	} else {
	mplew.writeShort(ServerPacketOpcode.REMOVE_DOOR.getValue());
	mplew.write(/*town ? 1 : */0);
	mplew.writeInt(oid);
	}

	return mplew.getPacket();
	}

	public static MaplePacket spawnSummon(MapleSummon summon, int skillLevel, boolean animated) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_SUMMON.getValue());
	mplew.writeInt(summon.getOwnerId());
	mplew.writeInt(summon.getObjectId());
	mplew.writeInt(summon.getSkill());
	mplew.write(100); //owner LEVEL
	mplew.write(skillLevel);
	mplew.writePos(summon.getPosition());
	mplew.write(4);
	mplew.writeShort(summon.isPuppet() ? 179 : 14);
	mplew.write(summon.getMovementType().getValue()); // 0 = don't move, 1 = follow (4th mage summons?), 2/4 = only tele follow, 3 = bird follow
	mplew.write(summon.isPuppet() ? 0 : 1); // 0 = Summon can't attack - but puppets don't attack with 1 either =.=
	mplew.writeShort(animated ? 0 : 1);

	return mplew.getPacket();
	}

	public static MaplePacket removeSummon(MapleSummon summon, boolean animated) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_SUMMON.getValue());
	mplew.writeInt(summon.getOwnerId());
	mplew.writeInt(summon.getObjectId());
	mplew.write(animated ? 4 : 1);

	return mplew.getPacket();
	}

	public static MaplePacket getRelogResponse() {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter(3);

	mplew.writeShort(ServerPacketOpcode.RELOG_RESPONSE.getValue());
	mplew.write(1);

	return mplew.getPacket();
	}

	/**
	* Possible values for <code>type</code>:<br>
	* 1: You cannot move that channel. Please try again later.<br>
	* 2: You cannot go into the cash shop. Please try again later.<br>
	* 3: The Item-Trading shop is currently unavailable, please try again later.<br>
	* 4: You cannot go into the trade shop, due to the limitation of user count.<br>
	* 5: You do not meet the minimum level requirement to access the Trade Shop.<br>
	*
	* @param type The type
	* @return The "block" packet.
	*/
	public static MaplePacket serverBlocked(int type) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MTS_OPEN.getValue());
	mplew.write(type);

	return mplew.getPacket();
	}

	public static MaplePacket serverMessage(String message) {
	return serverMessage(4, 0, message, true, false);
	}

	public static MaplePacket serverNotice(int type, String message) {
	return serverMessage(type, 0, message, false, false);
	}

	public static MaplePacket serverNotice(int type, int channel, String message) {
	return serverMessage(type, channel, message, false, false);
	}

	public static MaplePacket serverNotice(int type, int channel, String message, boolean smegaEar) {
	return serverMessage(type, channel, message, false, smegaEar);
	}

	private static MaplePacket serverMessage(int type, int channel, String message, boolean servermessage, boolean megaEar) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();
		/*	* 0: [Notice]<br>
		* 1: Popup<br>
		* 2: Megaphone<br>
		* 3: Super Megaphone<br>
		* 4: Scrolling message at top<br>
		* 5: Pink Text<br>
		* 6: Lightblue Text
		* 8: Item megaphone
		* 9: Heart megaphone
		* 10: Skull Super megaphone
		* 11: Green megaphone message?
		* 12: Three line of megaphone text
		* 13: End of file =.="
		* 14: Green Gachapon box
		* 15: Red Gachapon box*/
		mplew.writeShort(ServerPacketOpcode.SERVERMESSAGE.getValue());
		mplew.write(type);
		if (servermessage) {
			mplew.write(1);
		}
		mplew.writeMapleAsciiString(message);
		switch (type) {
			case 3:
			case 9:
			case 10:
				mplew.write(channel - 1); // channel
				mplew.write(megaEar ? 1 : 0);
			break;
			case 6:
				mplew.writeInt(0);
			break;
		}
		return mplew.getPacket();
	}

	public static MaplePacket getGachaponMega(final String name, final String message, final IItem item, final byte rareness) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SERVERMESSAGE.getValue());
		mplew.write(rareness == 2 ? 15 : 14);
		mplew.writeMapleAsciiString(name + message);
		mplew.writeInt(0); // 0~3 i think | no its a 5 @ msea 1.01
		mplew.writeMapleAsciiString(name);
		PacketHelper.addItemInfo(mplew, item, true, true, true);

		return mplew.getPacket();
	}

	public static MaplePacket tripleSmega(List<String> message, boolean ear, int channel) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SERVERMESSAGE.getValue());
	mplew.write(12);

	if (message.get(0) != null) {
	mplew.writeMapleAsciiString(message.get(0));
	}
	mplew.write(message.size());
	for (int i = 1; i < message.size(); i++) {
	if (message.get(i) != null) {
	mplew.writeMapleAsciiString(message.get(i));
	}
	}
	mplew.write(channel - 1);
	mplew.write(ear ? 1 : 0);

	return mplew.getPacket();
	}

	public static MaplePacket getAvatarMega(MapleCharacter chr, int channel, int itemId, String message, boolean ear) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.AVATAR_MEGA.getValue());
	mplew.writeInt(itemId);
	mplew.writeMapleAsciiString(chr.getName());
	mplew.writeMapleAsciiString(message);
	mplew.writeInt(channel - 1); // channel
	mplew.write(ear ? 1 : 0);
	PacketHelper.addCharLook(mplew, chr, true);

	return mplew.getPacket();
	}

	public static MaplePacket itemMegaphone(String msg, boolean whisper, int channel, IItem item) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SERVERMESSAGE.getValue());
	mplew.write(8);
	mplew.writeMapleAsciiString(msg);
	mplew.write(channel - 1);
	mplew.write(whisper ? 1 : 0);

	if (item == null) {
	mplew.write(0);
	} else {
	PacketHelper.addItemInfo(mplew, item, false, false, true);
	}
	return mplew.getPacket();
	}

	public static MaplePacket spawnNPC(MapleNPC life, boolean show) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_NPC.getValue());
	mplew.writeInt(life.getObjectId());
	mplew.writeInt(life.getId());
	mplew.writeShort(life.getPosition().x);
	mplew.writeShort(life.getCy());
	mplew.write(life.getF() == 1 ? 0 : 1);
	mplew.writeShort(life.getFh());
	mplew.writeShort(life.getRx0());
	mplew.writeShort(life.getRx1());
	mplew.write(show ? 1 : 0);

	return mplew.getPacket();
	}

	public static MaplePacket removeNPC(final int objectid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_NPC.getValue());
	mplew.writeInt(objectid);

	return mplew.getPacket();
	}

	public static MaplePacket spawnNPCRequestController(MapleNPC life, boolean MiniMap) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_NPC_REQUEST_CONTROLLER.getValue());
	mplew.write(1);
	mplew.writeInt(life.getObjectId());
	mplew.writeInt(life.getId());
	mplew.writeShort(life.getPosition().x);
	mplew.writeShort(life.getCy());
	mplew.write(life.getF() == 1 ? 0 : 1);
	mplew.writeShort(life.getFh());
	mplew.writeShort(life.getRx0());
	mplew.writeShort(life.getRx1());
	mplew.write(MiniMap ? 1 : 0);

	return mplew.getPacket();
	}

	public static MaplePacket spawnPlayerNPC(MapleNPCStats npc, int id) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PLAYER_NPC.getValue());
		mplew.write(1);
		mplew.writeInt(id);
		mplew.writeMapleAsciiString(npc.getName());
		mplew.write(0);
		mplew.write(npc.getSkin());
		mplew.writeInt(npc.getFace());
		mplew.write(0);
		mplew.writeInt(npc.getHair());
		Map<Byte, Integer> equip = npc.getEquips();
		Map<Byte, Integer> myEquip = new LinkedHashMap<Byte, Integer>();
		Map<Byte, Integer> maskedEquip = new LinkedHashMap<Byte, Integer>();
		for (byte position : equip.keySet()) {
			byte pos = (byte) (position * -1);
			if (pos < 100 && myEquip.get(pos) == null) {
				myEquip.put(pos, equip.get(position));
			} else if ((pos > 100 || pos == -128) && pos != 111) {
				pos -= 100;
				if (myEquip.get(pos) != null) {
					maskedEquip.put(pos, myEquip.get(pos));
				}
				myEquip.put(pos, equip.get(position));
			} else if (myEquip.get(pos) != null) {
				maskedEquip.put(pos, equip.get(position));
			}
		}
		for (Entry<Byte, Integer> entry : myEquip.entrySet()) {
			mplew.write(entry.getKey());
			mplew.writeInt(entry.getValue());
		}
		mplew.write(0xFF);
		for (Entry<Byte, Integer> entry : maskedEquip.entrySet()) {
			mplew.write(entry.getKey());
			mplew.writeInt(entry.getValue());
		}
		mplew.write(0xFF);
		Integer cWeapon = equip.get((byte) -111);
		if (cWeapon != null) {
			mplew.writeInt(cWeapon);
		} else {
			mplew.writeInt(0);
		}
		for (int i = 0; i < 3; i++) {
			mplew.writeInt(0);
		}

		return mplew.getPacket();
	}

	public static MaplePacket getChatText(int cidfrom, String text, boolean whiteBG, int show) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CHATTEXT.getValue());
	mplew.writeInt(cidfrom);
	mplew.write(whiteBG ? 1 : 0);
	mplew.writeMapleAsciiString(text);
	mplew.write(show);

	return mplew.getPacket();
	}

	public static MaplePacket GameMaster_Func(int value) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.write(HexTool.getByteArrayFromHexString("7A 00"));
	mplew.write(value);
	mplew.writeZeroBytes(17);

	return mplew.getPacket();
	}

	public static MaplePacket testCombo(int value) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.ARAN_COMBO.getValue());
	mplew.writeInt(value);

	return mplew.getPacket();
	}

	public static MaplePacket getPacketFromHexString(String hex) {
	return new ByteArrayMaplePacket(HexTool.getByteArrayFromHexString(hex));
	}

	public static final MaplePacket GainEXP_Monster(final int gain, final boolean white, final int Event_EXP, final int Wedding_EXP, final int Party_Ring_EXP, final int Party_EXP, final int Premium_EXP, final int Item_EXP, final int Rainbow_EXP, final int CLASS_EXP) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
		mplew.write(3); // 3 = exp, 4 = fame, 5 = mesos, 6 = guildpoints
		mplew.write(white ? 1 : 0);
		mplew.writeInt(gain);
		mplew.write(0); // 0 = no show in chat 1 = show in chat
		mplew.writeInt(Event_EXP); // Event Experience Bonus
		mplew.writeShort(0);
		mplew.writeInt(Wedding_EXP); // Wedding Experience Bonus
		mplew.writeInt(Party_Ring_EXP); // Party Ring Bonus EXP
		mplew.write(0);
		mplew.writeInt(Party_EXP); // Bonus EXP for PARTY
		mplew.writeInt(Item_EXP); // item equip bonus EXP
		mplew.writeInt(Premium_EXP); // Premium bonus exp
		mplew.writeInt(Rainbow_EXP); // Rainbow Week bonus EXP
		mplew.writeInt(CLASS_EXP); // Class Exp bonus

		return mplew.getPacket();
	}

	public static final MaplePacket GainEXP_Others(final int gain, final boolean inChat, final boolean white) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
		mplew.write(3); // 3 = exp, 4 = fame, 5 = mesos, 6 = guildpoints
		mplew.write(white ? 1 : 0);
		mplew.writeInt(gain);
		mplew.write(inChat ? 1 : 0);
		mplew.writeInt(0); // monster book bonus
		mplew.write(0); // Party percentage
		mplew.writeShort(0); // Party bouns
		mplew.writeZeroBytes(8);
		if (inChat) {
			mplew.writeZeroBytes(4); // some ring bonus/ party exp ??
			mplew.writeZeroBytes(10);
		} else { // some ring bonus/ party exp
			mplew.writeInt(0); // Party size
			mplew.writeZeroBytes(4); // Item equip bonus EXP
		}
		mplew.writeZeroBytes(4); // Premium bonus EXP
		mplew.writeZeroBytes(4); // Class bonus EXP
		mplew.writeZeroBytes(5);

		return mplew.getPacket();
	}

	public static final MaplePacket getShowFameGain(final int gain) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(5);
	mplew.writeInt(gain);

	return mplew.getPacket();
	}

	public static final MaplePacket showMesoGain(final int gain, final boolean inChat) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	if (!inChat) {
	mplew.write(0);
	mplew.write(1);
	mplew.write(0);
	mplew.writeInt(gain);
	mplew.writeShort(0); // inet cafe meso gain ?.o
	} else {
	mplew.write(6);
	mplew.writeInt(gain);
	}

	return mplew.getPacket();
	}

	public static MaplePacket getShowItemGain(int itemId, short quantity) {
	return getShowItemGain(itemId, quantity, false);
	}

	public static MaplePacket getShowItemGain(int itemId, short quantity, boolean inChat) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		if (inChat) {
			mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
			mplew.write(3);
			mplew.write(1); // item count
			mplew.writeInt(itemId);
			mplew.writeInt(quantity);
			/*	    for (int i = 0; i < count; i++) { // if ItemCount is handled.
			mplew.writeInt(itemId);
			mplew.writeInt(quantity);
			}*/
		} else {
			mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
			mplew.writeShort(0);
			mplew.writeInt(itemId);
			mplew.writeInt(quantity);
		}

		return mplew.getPacket();
	}

	public static MaplePacket showRewardItemAnimation(int itemId, String effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(0x0F);
		mplew.writeInt(itemId);
		mplew.write(1);
		mplew.writeMapleAsciiString(effect);

		return mplew.getPacket();
	}

	public static MaplePacket showRewardItemAnimation(int itemId, String effect, int from_playerid) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(from_playerid);
		mplew.write(0x0F);
		mplew.writeInt(itemId);
		mplew.write(1);
		mplew.writeMapleAsciiString(effect);

		return mplew.getPacket();
	}

	public static MaplePacket dropItemFromMapObject(MapleMapItem drop, Point dropfrom, Point dropto, byte mod) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DROP_ITEM_FROM_MAPOBJECT.getValue());
		mplew.write(mod); // 1 animation, 2 no animation, 3 spawn disappearing item [Fade], 4 spawn disappearing item
		mplew.writeInt(drop.getObjectId()); // item owner id
		mplew.write(drop.getMeso() > 0 ? 1 : 0); // 1 mesos, 0 item, 2 and above all item meso bag,
		mplew.writeInt(drop.getItemId()); // drop object ID
		mplew.writeInt(drop.getOwner()); // owner charid
		mplew.write(drop.getDropType()); // 0 = timeout for non-owner, 1 = timeout for non-owner's party, 2 = FFA, 3 = explosive/FFA
		mplew.writePos(dropto);
		mplew.writeInt(0);
		if (mod != 2) {
			mplew.writePos(dropfrom);
			mplew.writeShort(0);
		}
		if (drop.getMeso() == 0) {
			mplew.write(0);
			PacketHelper.addExpirationTime(mplew, drop.getItem().getExpiration());
		}
		mplew.writeShort(drop.isPlayerDrop() ? 0 : 1); // pet EQP pickup

		return mplew.getPacket();
	}

	public static MaplePacket spawnPlayerMapobject(MapleCharacter chr) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_PLAYER.getValue());
	mplew.writeInt(chr.getId());
	mplew.write(chr.getLevel());
	mplew.writeMapleAsciiString(chr.getName());

	if (chr.getGuildId() <= 0) {
	mplew.writeInt(0);
	mplew.writeInt(0);
	} else {
	final MapleGuildSummary gs = chr.getClient().getChannelServer().getGuildSummary(chr.getGuildId());

	if (gs != null) {
	mplew.writeMapleAsciiString(gs.getName());
	mplew.writeShort(gs.getLogoBG());
	mplew.write(gs.getLogoBGColor());
	mplew.writeShort(gs.getLogo());
	mplew.write(gs.getLogoColor());
	} else {
	mplew.writeInt(0);
	mplew.writeInt(0);
	}
	}
	mplew.writeShort(0);
	mplew.writeShort(1016);
	mplew.writeInt(0); //i think
	mplew.writeInt(chr.getBuffedValue(MapleBuffStat.MORPH) != null ? 2 : 0); // Should be a byte, but nvm

	long buffmask = 0;
	Integer buffvalue = null;
	if (chr.getBuffedValue(MapleBuffStat.DARKSIGHT) != null && !chr.isHidden()) {
	buffmask |= MapleBuffStat.DARKSIGHT.getValue();
	}
	if (chr.getBuffedValue(MapleBuffStat.COMBO) != null) {
	buffmask |= MapleBuffStat.COMBO.getValue();
	buffvalue = Integer.valueOf(chr.getBuffedValue(MapleBuffStat.COMBO).intValue());
	}
	if (chr.getBuffedValue(MapleBuffStat.SHADOWPARTNER) != null) {
	buffmask |= MapleBuffStat.SHADOWPARTNER.getValue();
	}
	if (chr.getBuffedValue(MapleBuffStat.SOULARROW) != null) {
	buffmask |= MapleBuffStat.SOULARROW.getValue();
	}
	if (chr.getBuffedValue(MapleBuffStat.DIVINE_BODY) != null) {
	buffmask |= MapleBuffStat.DIVINE_BODY.getValue();
	}
	if (chr.getBuffedValue(MapleBuffStat.BERSERK_FURY) != null) {
	buffmask |= MapleBuffStat.BERSERK_FURY.getValue();
	}
	if (chr.getBuffedValue(MapleBuffStat.MORPH) != null) {
	buffvalue = Integer.valueOf(chr.getBuffedValue(MapleBuffStat.MORPH).intValue());
	}

	mplew.writeInt((int) ((buffmask >> 32) & 0xffffffffL));
	if (buffvalue != null) {
	if (chr.getBuffedValue(MapleBuffStat.MORPH) != null) {
	mplew.writeShort(buffvalue);
	} else {
	mplew.write(buffvalue.byteValue());
	}
	}
	mplew.writeInt((int) (buffmask & 0xffffffffL));

	final int CHAR_MAGIC_SPAWN = Randomizer.nextInt();
	mplew.writeInt(0);
	mplew.writeShort(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.writeShort(0);
	mplew.writeLong(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.writeShort(0);
	mplew.writeLong(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.writeShort(0);

	if (chr.getBuffedValue(MapleBuffStat.MONSTER_RIDING) != null) {
	final IItem mount = chr.getInventory(MapleInventoryType.EQUIPPED).getItem((byte) -22);
	if (mount != null) {
	mplew.writeInt(mount.getItemId());
	mplew.writeInt(1004);
	} else {
	mplew.writeInt(1932000);
	mplew.writeInt(5221006);
	}
	mplew.write(1);
	mplew.writeInt(211951617);
	} else {
	mplew.writeLong(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	}
	mplew.writeLong(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.write(1);
	mplew.write(HexTool.getByteArrayFromHexString("FB 8E F5 A4")); // wtf is this?
	mplew.writeLong(0);
	mplew.writeShort(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.writeInt(0);
	mplew.writeLong(0);
	mplew.write(1);
	mplew.writeInt(CHAR_MAGIC_SPAWN);
	mplew.writeShort(0);
	mplew.writeShort(chr.getJob());
	PacketHelper.addCharLook(mplew, chr, false);
	mplew.writeLong(0);
	mplew.writeLong(0);
	mplew.writeInt(chr.getItemEffect());
	mplew.writeInt(chr.getChair());
	mplew.writePos(chr.getPosition());
	mplew.write(chr.getStance());
	mplew.writeShort(0); // FH
	mplew.write(0);
	mplew.writeInt(chr.getMount().getLevel()); // mount lvl
	mplew.writeInt(chr.getMount().getExp()); // exp
	mplew.writeInt(chr.getMount().getFatigue()); // tiredness
	mplew.writeShort(0);
	mplew.writeInt(0);
	if (chr.getCarnivalParty() != null) {
	mplew.write(chr.getCarnivalParty().getTeam());
	}
	return mplew.getPacket();
	}

	public static MaplePacket removePlayerFromMap(int cid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_PLAYER_FROM_MAP.getValue());
	mplew.writeInt(cid);

	return mplew.getPacket();
	}

	public static MaplePacket facialExpression(MapleCharacter from, int expression) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.FACIAL_EXPRESSION.getValue());
	mplew.writeInt(from.getId());
	mplew.writeInt(expression);
	mplew.writeInt(-1);
	mplew.write(0);

	return mplew.getPacket();
	}

	public static MaplePacket movePlayer(int cid, List<LifeMovementFragment> moves, Point startPos) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MOVE_PLAYER.getValue());
	mplew.writeInt(cid);
	mplew.writePos(startPos);
	mplew.writeInt(0);
	PacketHelper.serializeMovementList(mplew, moves);

	return mplew.getPacket();
	}

	public static MaplePacket moveSummon(int cid, int oid, Point startPos, List<LifeMovementFragment> moves) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MOVE_SUMMON.getValue());
	mplew.writeInt(cid);
	mplew.writeInt(oid);
	mplew.writePos(startPos);
	mplew.writeInt(0);
	PacketHelper.serializeMovementList(mplew, moves);

	return mplew.getPacket();
	}

	public static MaplePacket summonAttack(final int cid, final int summonSkillId, final byte animation, final List<SummonAttackEntry> allDamage, final int level) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SUMMON_ATTACK.getValue());
	mplew.writeInt(cid);
	mplew.writeInt(summonSkillId);
	mplew.write(level - 1);
	mplew.write(animation);
	mplew.write(allDamage.size());

	for (final SummonAttackEntry attackEntry : allDamage) {
	mplew.writeInt(attackEntry.getMonster().getObjectId()); // oid
	mplew.write(7); // who knows
	mplew.writeInt(attackEntry.getDamage()); // damage
	}
	return mplew.getPacket();
	}

	public static MaplePacket closeRangeAttack(int cid, int tbyte, int skill, int level, byte display, byte animation, byte speed, List<AttackPair> damage, final int lvl) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CLOSE_RANGE_ATTACK.getValue());
	mplew.writeInt(cid);
	mplew.write(tbyte);
	mplew.write(lvl);
	if (skill > 0) {
	mplew.write(level);
	mplew.writeInt(skill);
	} else {
	mplew.write(0);
	}
	mplew.write(0); // Added on v.82
	mplew.write(display);
	mplew.write(animation);
	mplew.write(speed);
	mplew.write(0); // Mastery
	mplew.writeInt(0);  // E9 03 BE FC

	if (skill == 4211006) {
	for (AttackPair oned : damage) {
	if (oned.attack != null) {
	mplew.writeInt(oned.objectid);
	mplew.write(0x07);
	mplew.write(oned.attack.size());
	for (Integer eachd : oned.attack) {
	// highest bit set = crit
	mplew.writeInt(eachd);
	}
	}
	}
	} else {
	for (AttackPair oned : damage) {
	if (oned.attack != null) {
	mplew.writeInt(oned.objectid);
	mplew.write(0x07);
	for (Integer eachd : oned.attack) {
	// highest bit set = crit
	mplew.writeInt(eachd);
	}
	}
	}
	}
	return mplew.getPacket();
	}

	public static MaplePacket rangedAttack(int cid, byte tbyte, int skill, int level, byte display, byte animation, byte speed, int itemid, List<AttackPair> damage, final Point pos, final int lvl) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.RANGED_ATTACK.getValue());
	mplew.writeInt(cid);
	mplew.write(tbyte);
	mplew.write(lvl);
	if (skill > 0) {
	mplew.write(level);
	mplew.writeInt(skill);
	} else {
	mplew.write(0);
	}
	mplew.write(0); // Added on v.82
	mplew.write(display);
	mplew.write(animation);
	mplew.write(speed);
	mplew.write(0); // Mastery level, who cares
	mplew.writeInt(itemid);

	for (AttackPair oned : damage) {
	if (oned.attack != null) {
	mplew.writeInt(oned.objectid);
	mplew.write(0x07);
	for (Integer eachd : oned.attack) {
	// highest bit set = crit
	mplew.writeInt(eachd.intValue());
	}
	}
	}
	mplew.writePos(pos); // Position

	return mplew.getPacket();
	}

	public static MaplePacket magicAttack(int cid, int tbyte, int skill, int level, byte display, byte animation, byte speed, List<AttackPair> damage, int charge, final int lvl) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MAGIC_ATTACK.getValue());
	mplew.writeInt(cid);
	mplew.write(tbyte);
	mplew.write(lvl);
	mplew.write(level);
	mplew.writeInt(skill);

	mplew.write(0); // Added on v.82
	mplew.write(display);
	mplew.write(animation);
	mplew.write(speed);
	mplew.write(0); // Mastery byte is always 0 because spells don't have a swoosh
	mplew.writeInt(0);

	for (AttackPair oned : damage) {
	if (oned.attack != null) {
	mplew.writeInt(oned.objectid);
	mplew.write(-1);
	for (Integer eachd : oned.attack) {
	// highest bit set = crit
	mplew.writeInt(eachd.intValue());
	}
	}
	}
	if (charge > 0) {
	mplew.writeInt(charge);
	}
	return mplew.getPacket();
	}

	public static MaplePacket getNPCShop(MapleClient c, int sid, List<MapleShopItem> items) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		final MapleItemInformationProvider ii = MapleItemInformationProvider.getInstance();
		mplew.writeShort(ServerPacketOpcode.OPEN_NPC_SHOP.getValue());
		mplew.writeInt(sid);
		mplew.writeShort(items.size());
		for (MapleShopItem item : items) {
			mplew.writeInt(item.getItemId());
			mplew.writeInt(item.getPrice());
			mplew.writeZeroBytes(16);
			if (!GameConstants.isThrowingStar(item.getItemId()) && !GameConstants.isBullet(item.getItemId())) {
				mplew.writeShort(1);
				mplew.writeShort(item.getBuyable());
			} else {
				mplew.writeShort(0);
				mplew.writeInt(0);
				mplew.writeShort(BitTools.doubleToShortBits(ii.getPrice(item.getItemId())));
				mplew.writeShort(ii.getSlotMax(c, item.getItemId()));
			}
		}

		return mplew.getPacket();
	}

	public static MaplePacket confirmShopTransaction(byte code) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CONFIRM_SHOP_TRANSACTION.getValue());
		mplew.write(code); // 8 = sell, 0 = buy, 0x20 = due to an error

		return mplew.getPacket();
	}

	public static MaplePacket addInventorySlot(MapleInventoryType type, IItem item) {
		return addInventorySlot(type, item, false);
	}

	public static MaplePacket addInventorySlot(MapleInventoryType type, IItem item, boolean fromDrop) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(fromDrop ? 1 : 0);
	mplew.writeShort(1); // add mode
	mplew.write(type.getType()); // iv type
	mplew.write(item.getPosition()); // slot id
	PacketHelper.addItemInfo(mplew, item, true, false);

	return mplew.getPacket();
	}

	public static MaplePacket updateInventorySlot(MapleInventoryType type, IItem item, boolean fromDrop) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(fromDrop ? 1 : 0);
	//	mplew.write((slot2 > 0 ? 1 : 0) + 1);
	mplew.write(1);
	mplew.write(1);
	mplew.write(type.getType()); // iv type
	mplew.writeShort(item.getPosition()); // slot id
	mplew.writeShort(item.getQuantity());
	/*	if (slot2 > 0) {
	mplew.write(1);
	mplew.write(type.getType());
	mplew.writeShort(slot2);
	mplew.writeShort(amt2);
	}*/
	return mplew.getPacket();
	}

	public static MaplePacket moveInventoryItem(MapleInventoryType type, short src, short dst) {
	return moveInventoryItem(type, src, dst, (byte) -1);
	}

	public static MaplePacket moveInventoryItem(MapleInventoryType type, short src, short dst, short equipIndicator) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("01 01 02"));
	mplew.write(type.getType());
	mplew.writeShort(src);
	mplew.writeShort(dst);
	if (equipIndicator != -1) {
	mplew.write(equipIndicator);
	}
	return mplew.getPacket();
	}

	public static MaplePacket moveAndMergeInventoryItem(MapleInventoryType type, byte src, byte dst, short total) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("01 02 03"));
	mplew.write(type.getType());
	mplew.writeShort(src);
	mplew.write(1); // merge mode?
	mplew.write(type.getType());
	mplew.writeShort(dst);
	mplew.writeShort(total);

	return mplew.getPacket();
	}

	public static MaplePacket moveAndMergeWithRestInventoryItem(MapleInventoryType type, byte src, byte dst, short srcQ, short dstQ) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("01 02 01"));
	mplew.write(type.getType());
	mplew.writeShort(src);
	mplew.writeShort(srcQ);
	mplew.write(HexTool.getByteArrayFromHexString("01"));
	mplew.write(type.getType());
	mplew.writeShort(dst);
	mplew.writeShort(dstQ);

	return mplew.getPacket();
	}

	public static MaplePacket clearInventoryItem(MapleInventoryType type, short slot, boolean fromDrop) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(fromDrop ? 1 : 0);
	mplew.write(HexTool.getByteArrayFromHexString("01 03"));
	mplew.write(type.getType());
	mplew.writeShort(slot);

	return mplew.getPacket();
	}

	public static MaplePacket updateSpecialItemUse(IItem item, byte invType) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(0); // could be from drop
	mplew.write(2); // always 2
	mplew.write(3); // quantity > 0 (?)
	mplew.write(invType); // Inventory type
	mplew.writeShort(item.getPosition()); // item slot
	mplew.write(0);
	mplew.write(invType);
	if (item.getType() == 1) {
	mplew.writeShort(item.getPosition()); // wtf repeat
	} else {
	mplew.write(item.getPosition());
	}
	PacketHelper.addItemInfo(mplew, item, true, true);
	if (item.getPosition() < 0) {

	mplew.write(2); //?

	}

	return mplew.getPacket();
	}

	public static MaplePacket scrolledItem(IItem scroll, IItem item, boolean destroyed) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(1); // fromdrop always true
	mplew.write(destroyed ? 2 : 3);
	mplew.write(scroll.getQuantity() > 0 ? 1 : 3);
	mplew.write(GameConstants.getInventoryType(scroll.getItemId()).getType());
	mplew.writeShort(scroll.getPosition());

	if (scroll.getQuantity() > 0) {
	mplew.writeShort(scroll.getQuantity());
	}
	mplew.write(3);
	if (!destroyed) {
	mplew.write(MapleInventoryType.EQUIP.getType());
	mplew.writeShort(item.getPosition());
	mplew.write(0);
	}
	mplew.write(MapleInventoryType.EQUIP.getType());
	mplew.writeShort(item.getPosition());
	if (!destroyed) {
	PacketHelper.addItemInfo(mplew, item, true, true);
	}
	mplew.write(1);

	return mplew.getPacket();
	}

	public static MaplePacket getScrollEffect(int chr, ScrollResult scrollSuccess, boolean legendarySpirit) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_SCROLL_EFFECT.getValue());
	mplew.writeInt(chr);

	switch (scrollSuccess) {
	case SUCCESS:
	mplew.writeShort(1);
	mplew.writeShort(legendarySpirit ? 1 : 0);
	break;
	case FAIL:
	mplew.writeShort(0);
	mplew.writeShort(legendarySpirit ? 1 : 0);
	break;
	case CURSE:
	mplew.write(0);
	mplew.write(1);
	mplew.writeShort(legendarySpirit ? 1 : 0);
	break;
	}
	mplew.write(0);
	return mplew.getPacket();
	}

	public static final MaplePacket ItemMaker_Success() {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();
		//D6 00 00 00 00 00 01 00 00 00 00 DC DD 40 00 01 00 00 00 01 00 00 00 8A 1C 3D 00 01 00 00 00 00 00 00 00 00 B0 AD 01 00
		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(0x12);
		mplew.writeZeroBytes(4);

		return mplew.getPacket();
	}

	public static final MaplePacket ItemMaker_Success_3rdParty(final int from_playerid) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(from_playerid);
		mplew.write(0x12);
		mplew.writeZeroBytes(4);

		return mplew.getPacket();
	}

	public static MaplePacket explodeDrop(int oid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_ITEM_FROM_MAP.getValue());
	mplew.write(4); // 4 = Explode
	mplew.writeInt(oid);
	mplew.writeShort(655);

	return mplew.getPacket();
	}

	public static MaplePacket removeItemFromMap(int oid, int animation, int cid) {
	return removeItemFromMap(oid, animation, cid, false, 0);
	}

	public static MaplePacket removeItemFromMap(int oid, int animation, int cid, boolean pet, int slot) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_ITEM_FROM_MAP.getValue());
	mplew.write(animation); // 0 = Expire, 1 = without animation, 2 = pickup, 4 = explode
	mplew.writeInt(oid);
	if (animation >= 2) {
	mplew.writeInt(cid);
	if (pet) { // allow pet pickup?
	mplew.write(slot);
	}
	}
	return mplew.getPacket();
	}

	public static MaplePacket updateCharLook(MapleCharacter chr) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.UPDATE_CHAR_LOOK.getValue());
	mplew.writeInt(chr.getId());
	mplew.write(1);
	PacketHelper.addCharLook(mplew, chr, false);
	MapleInventory iv = chr.getInventory(MapleInventoryType.EQUIPPED);
	Collection<IItem> equippedC = iv.list();
	List<Item> equipped = new ArrayList<Item>(equippedC.size());
	for (IItem item : equippedC) {
	equipped.add((Item) item);
	}
	Collections.sort(equipped);
	List<MapleRing> rings = new ArrayList<MapleRing>();
	for (Item item : equipped) {
	if (((IEquip) item).getRingId() > -1) {
	rings.add(MapleRing.loadFromDb(((IEquip) item).getRingId()));
	}
	}
	Collections.sort(rings);

	if (rings.size() > 0) {
	for (MapleRing ring : rings) {
	mplew.write(1);
	mplew.writeInt(ring.getRingId());
	mplew.writeInt(0);
	mplew.writeInt(ring.getPartnerRingId());
	mplew.writeInt(0);
	mplew.writeInt(ring.getItemId());
	}
	} else {
	mplew.write(0);
	}
	mplew.writeShort(0);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static MaplePacket dropInventoryItem(MapleInventoryType type, short src) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("01 01 03"));
	mplew.write(type.getType());
	mplew.writeShort(src);
	if (src < 0) {
	mplew.write(1);
	}
	return mplew.getPacket();
	}

	public static MaplePacket dropInventoryItemUpdate(MapleInventoryType type, IItem item) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("01 01 01"));
	mplew.write(type.getType());
	mplew.writeShort(item.getPosition());
	mplew.writeShort(item.getQuantity());

	return mplew.getPacket();
	}

	public static MaplePacket damagePlayer(int skill, int monsteridfrom, int cid, int damage, int fake, byte direction, int reflect, boolean is_pg, int oid, int pos_x, int pos_y) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DAMAGE_PLAYER.getValue());
		mplew.writeInt(cid);
		mplew.write(skill);
		mplew.writeInt(damage);
		mplew.writeInt(monsteridfrom);
		mplew.write(direction);
		if (reflect > 0) {
			mplew.write(reflect);
			mplew.write(is_pg ? 1 : 0);
			mplew.writeInt(oid);
			mplew.write(6);
			mplew.writeShort(pos_x);
			mplew.writeShort(pos_y);
			mplew.write(0);
		} else {
			mplew.writeShort(0);
		}
		mplew.writeInt(damage);
		if (fake > 0) {
			mplew.writeInt(fake);
		}

		return mplew.getPacket();
	}

	public static final MaplePacket startQuest(final MapleCharacter c, final short quest, final String data) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(1);
	mplew.writeShort(quest);
	mplew.write(1);

	mplew.writeMapleAsciiString(data != null ? data : "");

	return mplew.getPacket();
	}

	public static MaplePacket forfeitQuest(MapleCharacter c, short quest) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(1);
	mplew.writeShort(quest);
	mplew.writeShort(0);
	mplew.write(0);
	mplew.writeInt(0);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static final MaplePacket completeQuest(final short quest) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
		mplew.write(1);
		mplew.writeShort(quest);
		mplew.write(2);
		mplew.writeLong(PacketHelper.getTime(System.currentTimeMillis()));

		return mplew.getPacket();
	}

	public static final MaplePacket updateInfoQuest(final int quest, final String data) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(0x0B);
	mplew.writeShort(quest);
	mplew.writeMapleAsciiString(data);

	return mplew.getPacket();
	}

	public static MaplePacket updateQuestInfo(MapleCharacter c, short quest, int npc, byte progress) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.UPDATE_QUEST_INFO.getValue());
	mplew.write(progress);
	mplew.writeShort(quest);
	mplew.writeInt(npc);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static final MaplePacket charInfo(final MapleCharacter chr, final boolean isSelf) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CHAR_INFO.getValue());
	mplew.writeInt(chr.getId());
	mplew.write(chr.getLevel());
	mplew.writeShort(chr.getJob());
	mplew.writeShort(chr.getFame());
	mplew.write(0); // heart red or gray
	if (chr.getGuildId() <= 0) {
	mplew.writeMapleAsciiString("-");
	mplew.writeMapleAsciiString("");
	//mplew.writeMapleAsciiString("Resets: " + chr.getReborns());
	} else {
		final MapleGuildSummary gs = chr.getClient().getChannelServer().getGuildSummary(chr.getGuildId());
		mplew.writeMapleAsciiString(gs.getName());
		final MapleAlliance alliance = chr.getGuild().getAlliance(chr.getClient());
		if (alliance == null) {
			mplew.writeMapleAsciiString("");
			//mplew.writeMapleAsciiString("Resets: " + chr.getReborns());
		} else {
			mplew.writeMapleAsciiString(alliance.getName());
		}
	}
	mplew.write(0);
	final IItem inv = chr.getInventory(MapleInventoryType.EQUIPPED).getItem((byte) -114);
	final int peteqid = inv != null ? inv.getItemId() : 0;
	for (final MaplePet pet : chr.getPets()) {
		if (pet.getSummoned()) {
			mplew.write(pet.getUniqueId());
			mplew.writeInt(pet.getPetItemId()); // petid
			mplew.writeMapleAsciiString(pet.getName());
			mplew.write(pet.getLevel()); // pet level
			mplew.writeShort(pet.getCloseness()); // pet closeness
			mplew.write(pet.getFullness()); // pet fullness
			mplew.writeShort(0);
			mplew.writeInt(peteqid);
		}
	}
	mplew.write(0); // End of pet
	if (chr.getInventory(MapleInventoryType.EQUIPPED).getItem((byte) -22) != null) {
		final MapleMount mount = chr.getMount();
		mplew.write(1);
		mplew.writeInt(mount.getLevel());
		mplew.writeInt(mount.getExp());
		mplew.writeInt(mount.getFatigue());
	} else {
		mplew.write(0);
	}
	final int wishlistSize = chr.getWishlistSize();
	mplew.write(wishlistSize);
	if (wishlistSize > 0) {
		final int[] wishlist = chr.getWishlist();
		for (int i = 0; i < wishlistSize; i++) {
			mplew.writeInt(wishlist[i]);
		}
	}
	chr.getMonsterBook().addCharInfoPacket(chr.getMonsterBookCover(), mplew);
	mplew.writeZeroBytes(6);

	return mplew.getPacket();
	}

	private static void writeLongMask(MaplePacketLittleEndianWriter mplew, List<Pair<MapleBuffStat, Integer>> statups) {
	long firstmask = 0;
	long secondmask = 0;
	for (Pair<MapleBuffStat, Integer> statup : statups) {
	if (statup.getLeft().isFirst()) {
	firstmask |= statup.getLeft().getValue();
	} else {
	secondmask |= statup.getLeft().getValue();
	}
	}
	mplew.writeLong(firstmask);
	mplew.writeLong(secondmask);
	}

	// List<Pair<MapleDisease, Integer>>
	private static void writeLongDiseaseMask(MaplePacketLittleEndianWriter mplew, List<Pair<MapleDisease, Integer>> statups) {
	long firstmask = 0;
	long secondmask = 0;
	for (Pair<MapleDisease, Integer> statup : statups) {
	if (statup.getLeft().isFirst()) {
	firstmask |= statup.getLeft().getValue();
	} else {
	secondmask |= statup.getLeft().getValue();
	}
	}
	mplew.writeLong(firstmask);
	mplew.writeLong(secondmask);
	}

	private static void writeLongMaskFromList(MaplePacketLittleEndianWriter mplew, List<MapleBuffStat> statups) {
	long firstmask = 0;
	long secondmask = 0;
	for (MapleBuffStat statup : statups) {
	if (statup.isFirst()) {
	firstmask |= statup.getValue();
	} else {
	secondmask |= statup.getValue();
	}
	}
	mplew.writeLong(firstmask);
	mplew.writeLong(secondmask);
	}

	public static MaplePacket giveMount(int buffid, int skillid, List<Pair<MapleBuffStat, Integer>> statups) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());

	writeLongMask(mplew, statups);

	mplew.writeShort(0);
	mplew.writeInt(buffid); // 1902000 saddle
	mplew.writeInt(skillid); // skillid
	mplew.writeInt(0); // Server tick value
	mplew.writeShort(0);
	mplew.write(0);
	mplew.write(1); // Total buffed times

	return mplew.getPacket();
	}

	public static MaplePacket givePirate(List<Pair<MapleBuffStat, Integer>> statups, int duration, int skillid) {
	final boolean infusion = skillid == 5121009 || skillid == 15111005;
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
	writeLongMask(mplew, statups);

	mplew.writeShort(0);
	for (Pair<MapleBuffStat, Integer> stat : statups) {
	mplew.writeInt(stat.getRight().intValue());
	mplew.writeLong(skillid);
	mplew.writeZeroBytes(infusion ? 6 : 1);
	mplew.writeShort(duration);
	}
	mplew.writeShort(infusion ? 600 : 0);
	if (!infusion) {
	mplew.write(1); //does this only come in dash?
	}
	return mplew.getPacket();
	}

	public static MaplePacket giveForeignPirate(List<Pair<MapleBuffStat, Integer>> statups, int duration, int cid, int skillid) {
	final boolean infusion = skillid == 5121009 || skillid == 15111005;
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_FOREIGN_BUFF.getValue());
	mplew.writeInt(cid);
	writeLongMask(mplew, statups);
	mplew.writeShort(0);
	for (Pair<MapleBuffStat, Integer> stat : statups) {
	mplew.writeInt(stat.getRight().intValue());
	mplew.writeLong(skillid);
	mplew.writeZeroBytes(infusion ? 7 : 1);
	mplew.writeShort(duration);//duration... seconds 
	}
	mplew.writeShort(infusion ? 600 : 0);
	return mplew.getPacket();
	}

	/*    public static MaplePacket giveEnergyCharge(List<Pair<MapleBuffStat, Integer>> statups, int buffid, int bufflength) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());

	writeLongMask(mplew, statups);

	for (Pair<MapleBuffStat, Integer> stat : statups) {
	mplew.writeShort(stat.getRight().shortValue());
	mplew.writeShort(0);
	mplew.writeInt(buffid);
	mplew.writeInt(0);
	mplew.writeShort(bufflength);
	mplew.write(0);
	}
	mplew.writeShort(0);
	mplew.write(0);

	return mplew.getPacket();
	}*/
	public static MaplePacket giveEnergyChargeTest(int bar) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
	long mask = 0;
	mask |= MapleBuffStat.ENERGY_CHARGE.getValue();

	mplew.writeLong(mask);
	mplew.writeLong(0);
	mplew.writeShort(0);
	mplew.writeShort(bar); // 0 = no bar, 10000 = full bar
	mplew.writeLong(0);
	mplew.writeInt(0);
	mplew.writeShort(0);
	mplew.write(0);

	return mplew.getPacket();
	}

	public static MaplePacket giveInfusion(List<Pair<MapleBuffStat, Integer>> statups, int buffid, int bufflength) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
	// 17 00 00 00 00 00 00 00 00 00 00 01 00 00 00 00 00 00 07 00 AE E1 3E 00 68 B9 01 00 00 00 00 00

	writeLongMask(mplew, statups);

	/*	for (Pair<MapleBuffStat, Integer> statup : statups) {
	mplew.writeInt(statup.getRight().shortValue());
	mplew.writeInt(buffid);
	mplew.writeInt(0);
	mplew.writeShort(bufflength);
	mplew.write(0);
	}
	mplew.writeShort(0); // delay,  wk charges have 600 here o.o
	mplew.writeShort(0); // combo 600, too
	mplew.write(2); // Test*/
	mplew.write(HexTool.getByteArrayFromHexString("00 00 FF FF FF FF F1 23 4E 00 00 00 00 00 00 00 00 00 00 00 6E 00 58 02"));

	return mplew.getPacket();
	}

	public static MaplePacket giveHoming(int skillid, int mobid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
	mplew.writeLong(MapleBuffStat.HOMING_BEACON.getValue());
	mplew.writeLong(0);

	mplew.writeShort(0);
	mplew.writeInt(1);
	mplew.writeLong(skillid);
	mplew.write(0);
	mplew.writeInt(mobid);
	mplew.writeShort(0);
	return mplew.getPacket();
	}

	public static MaplePacket giveForeignInfusion(int cid, int speed, int duration) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_FOREIGN_BUFF.getValue());
	mplew.writeInt(cid);
	mplew.writeLong(0);
	mplew.writeLong(MapleBuffStat.MORPH.getValue()); //transform buffstat
	mplew.writeShort(0);
	mplew.writeInt(speed);
	mplew.writeInt(5121009);
	mplew.writeLong(0);
	mplew.writeInt(duration);
	mplew.writeShort(0);

	return mplew.getPacket();
	}

	public static MaplePacket giveBuff(int buffid, int bufflength, List<Pair<MapleBuffStat, Integer>> statups, MapleStatEffect effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
		writeLongMask(mplew, statups);
		for (Pair<MapleBuffStat, Integer> statup : statups) {
			mplew.writeShort(statup.getRight().shortValue());
			mplew.writeInt(buffid);
			mplew.writeInt(bufflength);
		}
		mplew.writeShort(0); // delay,  wk charges have 600 here o.o
		mplew.writeShort(0); // combo 600, too
		mplew.write(effect.isMorph() || effect.isPirateMorph() ? 2 : 0);

		return mplew.getPacket();
	}

	public static MaplePacket giveDebuff(final List<Pair<MapleDisease, Integer>> statups, final MobSkill skill) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GIVE_BUFF.getValue());
		writeLongDiseaseMask(mplew, statups);
		for (Pair<MapleDisease, Integer> statup : statups) {
			mplew.writeShort(statup.getRight().shortValue());
			mplew.writeShort(skill.getSkillId());
			mplew.writeShort(skill.getSkillLevel());
			mplew.writeInt((int) skill.getDuration());
		}
		mplew.writeShort(0); // ??? wk charges have 600 here o.o
		mplew.writeShort(2160); //Delay
		mplew.write(1);

		return mplew.getPacket();
	}

	public static MaplePacket giveForeignDebuff(int cid, final List<Pair<MapleDisease, Integer>> statups, MobSkill skill) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.GIVE_FOREIGN_BUFF.getValue());
	mplew.writeInt(cid);

	writeLongDiseaseMask(mplew, statups);

	if (skill.getSkillId() == 125) {
	mplew.writeShort(0);
	}
	mplew.writeShort(skill.getSkillId());
	mplew.writeShort(skill.getSkillLevel());
	mplew.writeShort(0); // same as give_buff
	mplew.writeShort(900); //Delay

	return mplew.getPacket();
	}

	public static MaplePacket cancelForeignDebuff(int cid, long mask) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CANCEL_FOREIGN_BUFF.getValue());
	mplew.writeInt(cid);
	mplew.writeLong(0);
	mplew.writeLong(mask);

	return mplew.getPacket();
	}

	public static MaplePacket showMonsterRiding(int cid, List<Pair<MapleBuffStat, Integer>> statups, int itemId, int skillId) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GIVE_FOREIGN_BUFF.getValue());
		mplew.writeInt(cid);
		writeLongMask(mplew, statups);
		mplew.writeShort(0);
		mplew.writeInt(itemId);
		mplew.writeInt(skillId);
		mplew.writeInt(0);
		mplew.writeShort(0);
		mplew.write(0);
		mplew.write(0);

		return mplew.getPacket();
	}

	public static MaplePacket giveForeignBuff(int cid, List<Pair<MapleBuffStat, Integer>> statups, MapleStatEffect effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GIVE_FOREIGN_BUFF.getValue());
		mplew.writeInt(cid);
		writeLongMask(mplew, statups);
		for (Pair<MapleBuffStat, Integer> statup : statups) {
			if (effect.isMorph() && !effect.isPirateMorph()) {
				mplew.write(statup.getRight().byteValue());
			} else {
				mplew.writeShort(statup.getRight().shortValue());
			}
		}
		mplew.writeShort(0); // same as give_buff
		if (effect.isMorph()) {
			mplew.writeShort(0);
		}
		mplew.write(0);

		return mplew.getPacket();
	}

	public static MaplePacket cancelForeignBuff(int cid, List<MapleBuffStat> statups) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CANCEL_FOREIGN_BUFF.getValue());
	mplew.writeInt(cid);

	writeLongMaskFromList(mplew, statups);

	return mplew.getPacket();
	}

	public static MaplePacket cancelBuff(List<MapleBuffStat> statups) {
	return cancelBuff(statups, false);
	}

	public static MaplePacket cancelBuff(List<MapleBuffStat> statups, boolean mount) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CANCEL_BUFF.getValue());

	if (statups != null) {
	writeLongMaskFromList(mplew, statups);	
	mplew.write(3);
	} else {
	mplew.writeLong(0);
	mplew.writeInt(0x40);
	mplew.writeInt(0x1000);
	}

	return mplew.getPacket();
	}

	public static MaplePacket cancelDebuff(long mask) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CANCEL_BUFF.getValue());
	mplew.writeLong(0);
	mplew.writeLong(mask);
	mplew.write(1);

	return mplew.getPacket();
	}

	public static MaplePacket updateMount(MapleCharacter chr, boolean levelup) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.UPDATE_MOUNT.getValue());
	mplew.writeInt(chr.getId());
	mplew.writeInt(chr.getMount().getLevel());
	mplew.writeInt(chr.getMount().getExp());
	mplew.writeInt(chr.getMount().getFatigue());
	mplew.write(levelup ? 1 : 0);

	return mplew.getPacket();
	}

	public static MaplePacket mountInfo(MapleCharacter chr) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.UPDATE_MOUNT.getValue());
	mplew.writeInt(chr.getId());
	mplew.write(1);
	mplew.writeInt(chr.getMount().getLevel());
	mplew.writeInt(chr.getMount().getExp());
	mplew.writeInt(chr.getMount().getFatigue());

	return mplew.getPacket();
	}

	public static MaplePacket getPlayerShopChat(MapleCharacter c, String chat, boolean owner) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("06 08"));
	mplew.write(owner ? 0 : 1);
	mplew.writeMapleAsciiString(c.getName() + " : " + chat);

	return mplew.getPacket();
	}

	public static MaplePacket getPlayerShopNewVisitor(MapleCharacter c, int slot) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("04 0" + slot));
	PacketHelper.addCharLook(mplew, c, false);
	mplew.writeMapleAsciiString(c.getName());
	mplew.writeShort(c.getJob());

	return mplew.getPacket();
	}

	public static MaplePacket getPlayerShopRemoveVisitor(int slot) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(HexTool.getByteArrayFromHexString("0A 0" + slot));

	return mplew.getPacket();
	}

	public static MaplePacket getTradePartnerAdd(MapleCharacter c) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(4);
	mplew.write(1);
	PacketHelper.addCharLook(mplew, c, false);
	mplew.writeMapleAsciiString(c.getName());
	mplew.writeShort(c.getJob());

	return mplew.getPacket();
	}

	public static MaplePacket getTradeInvite(MapleCharacter c) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(2);
	mplew.write(3);
	mplew.writeMapleAsciiString(c.getName());
	mplew.writeInt(0); // Trade ID

	return mplew.getPacket();
	}

	public static MaplePacket getTradeMesoSet(byte number, int meso) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(0xF);
	mplew.write(number);
	mplew.writeInt(meso);

	return mplew.getPacket();
	}

	public static MaplePacket getTradeItemAdd(byte number, IItem item) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(0xE);
	mplew.write(number);
	PacketHelper.addItemInfo(mplew, item, false, false, true);

	return mplew.getPacket();
	}

	public static MaplePacket getTradeStart(MapleClient c, MapleTrade trade, byte number) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(5);
	mplew.write(3);
	mplew.write(2);
	mplew.write(number);

	if (number == 1) {
	mplew.write(0);
	PacketHelper.addCharLook(mplew, trade.getPartner().getChr(), false);
	mplew.writeMapleAsciiString(trade.getPartner().getChr().getName());
	mplew.writeShort(trade.getPartner().getChr().getJob());
	}
	mplew.write(number);
	PacketHelper.addCharLook(mplew, c.getPlayer(), false);
	mplew.writeMapleAsciiString(c.getPlayer().getName());
	mplew.writeShort(c.getPlayer().getJob());
	mplew.write(0xFF);

	return mplew.getPacket();
	}

	public static MaplePacket getTradeConfirmation() {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(0x10);

	return mplew.getPacket();
	}

	public static MaplePacket TradeMessage(final byte UserSlot, final byte message) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(0xA);
	mplew.write(UserSlot);
	mplew.write(message);
	//0x06 = success [tax is automated]
	//0x07 = unsuccessful
	//0x08 = "You cannot make the trade because there are some items which you cannot carry more than one."
	//0x09 = "You cannot make the trade because the other person's on a different map."

	return mplew.getPacket();
	}

	public static MaplePacket getTradeCancel(final byte UserSlot) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.PLAYER_INTERACTION.getValue());
	mplew.write(0xA);
	mplew.write(UserSlot);
	mplew.write(2);

	return mplew.getPacket();
	}

	public static MaplePacket getNPCTalk(int npc, byte msgType, String talk, String endBytes, byte type) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.NPC_TALK.getValue());
		mplew.write(4);
		mplew.writeInt(npc);
		mplew.write(msgType);
		mplew.write(type); // 1 = No ESC, 3 = show character + no sec
		mplew.writeMapleAsciiString(talk);
		mplew.write(HexTool.getByteArrayFromHexString(endBytes));

		return mplew.getPacket();
	}

	public static final MaplePacket getMapSelection(final int npcid, final String sel) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.NPC_TALK.getValue());
	mplew.write(4);
	mplew.writeInt(npcid);
	mplew.write(0xE);
	mplew.writeZeroBytes(5);
	mplew.writeInt(5);
	mplew.writeMapleAsciiString(sel);

	return mplew.getPacket();
	}

	public static MaplePacket getNPCTalkStyle(int npc, String talk, int... args) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.NPC_TALK.getValue());
		mplew.write(4);
		mplew.writeInt(npc);
		mplew.writeShort(8);
		mplew.writeMapleAsciiString(talk);
		mplew.write(args.length);
		for (int i = 0; i < args.length; i++) {
			mplew.writeInt(args[i]);
		}

		return mplew.getPacket();
	}

	public static MaplePacket getNPCTalkNum(int npc, String talk, int def, int min, int max) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.NPC_TALK.getValue());
	mplew.write(4);
	mplew.writeInt(npc);
	mplew.writeShort(4);
	mplew.writeMapleAsciiString(talk);
	mplew.writeInt(def);
	mplew.writeInt(min);
	mplew.writeInt(max);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static MaplePacket getNPCTalkText(int npc, String talk) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.NPC_TALK.getValue());
		mplew.write(4);
		mplew.writeInt(npc);
		mplew.writeShort(3);
		mplew.writeMapleAsciiString(talk);
		mplew.writeInt(0);
		mplew.writeInt(0);

		return mplew.getPacket();
	}

	public static MaplePacket showForeignEffect(int cid, int effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(cid);
		mplew.write(effect); // 0 = Level up, 8 = job change

		return mplew.getPacket();
	}

	public static MaplePacket showBuffeffect(int cid, int skillid, int effectid) {
		return showBuffeffect(cid, skillid, effectid, (byte) 3);
	}

	public static MaplePacket showBuffeffect(int cid, int skillid, int effectid, byte direction) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(cid);
		mplew.write(effectid);
		mplew.writeInt(skillid);
		mplew.write(1); // probably buff level but we don't know it and it doesn't really matter
		mplew.write(1);

		if (direction != (byte) 3) {
			mplew.write(direction);
		}
		return mplew.getPacket();
	}

	public static MaplePacket showOwnBuffEffect(int skillid, int effectid) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(effectid);
		mplew.writeInt(skillid);
		mplew.write(1); // probably buff level but we don't know it and it doesn't really matter
		mplew.write(1);

		return mplew.getPacket();
	}

	public static MaplePacket showOwnBerserk(int skilllevel, boolean Berserk) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(1);
		mplew.writeInt(1320006);
		mplew.write(skilllevel);
		mplew.write(Berserk ? 1 : 0);

		return mplew.getPacket();
	}

	public static MaplePacket showBerserk(int cid, int skilllevel, boolean Berserk) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(cid);
		mplew.write(1);
		mplew.writeInt(1320006);
		mplew.write(skilllevel);
		mplew.write(Berserk ? 1 : 0);

		return mplew.getPacket();
	}

	public static MaplePacket showSpecialEffect(int effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(effect);

		return mplew.getPacket();
	}

	public static MaplePacket showSpecialEffect(int cid, int effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_FOREIGN_EFFECT.getValue());
		mplew.writeInt(cid);
		mplew.write(effect);

		return mplew.getPacket();
	}

	public static MaplePacket updateSkill(int skillid, int level, int masterlevel) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.UPDATE_SKILLS.getValue());
	mplew.write(1);
	mplew.writeShort(1);
	mplew.writeInt(skillid);
	mplew.writeInt(level);
	mplew.writeInt(masterlevel);
	mplew.write(0);
	PacketHelper.addExpirationTime(mplew, -1);
	mplew.write(4);

	return mplew.getPacket();
	}

	public static final MaplePacket updateQuestMobKills(final MapleQuestStatus status) {
	final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(1);
	mplew.writeShort(status.getQuest().getId());
	mplew.write(1);

	final StringBuilder sb = new StringBuilder();
	for (final int kills : status.getMobKills().values()) {
	sb.append(StringUtil.getLeftPaddedStr(String.valueOf(kills), '0', 3));
	}
	mplew.writeMapleAsciiString(sb.toString());
	mplew.writeZeroBytes(8);

	return mplew.getPacket();
	}

	public static MaplePacket getShowQuestCompletion(int id) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_QUEST_COMPLETION.getValue());
	mplew.writeShort(id);

	return mplew.getPacket();
	}

	public static MaplePacket getKeymap(MapleKeyLayout layout) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.KEYMAP.getValue());
	mplew.write(0);
	layout.writeData(mplew);

	return mplew.getPacket();
	}

	public static MaplePacket getWhisper(String sender, int channel, String text) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.WHISPER.getValue());
	mplew.write(0x12);
	mplew.writeMapleAsciiString(sender);
	mplew.writeShort(channel - 1);
	mplew.writeMapleAsciiString(text);

	return mplew.getPacket();
	}

	public static MaplePacket getWhisperReply(String target, byte reply) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.WHISPER.getValue());
	mplew.write(0x0A); // whisper?
	mplew.writeMapleAsciiString(target);
	mplew.write(reply);//  0x0 = cannot find char, 0x1 = success

	return mplew.getPacket();
	}

	public static MaplePacket getFindReplyWithMap(String target, int mapid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.WHISPER.getValue());
	mplew.write(9);
	mplew.writeMapleAsciiString(target);
	mplew.write(1);
	mplew.writeInt(mapid);
	mplew.writeZeroBytes(8); // ?? official doesn't send zeros here but whatever

	return mplew.getPacket();
	}

	public static MaplePacket getFindReply(String target, int channel) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.WHISPER.getValue());
	mplew.write(9);
	mplew.writeMapleAsciiString(target);
	mplew.write(3);
	mplew.writeInt(channel - 1);

	return mplew.getPacket();
	}

	public static MaplePacket getInventoryFull() {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.MODIFY_INVENTORY_ITEM.getValue());
	mplew.write(1);
	mplew.write(0);

	return mplew.getPacket();
	}

	public static MaplePacket getShowInventoryFull() {
	return getShowInventoryStatus(0xff);
	}

	public static MaplePacket showItemUnavailable() {
	return getShowInventoryStatus(0xfe);
	}

	public static MaplePacket getShowInventoryStatus(int mode) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
	mplew.write(0);
	mplew.write(mode);
	mplew.writeInt(0);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static MaplePacket getStorage(int npcId, byte slots, Collection<IItem> items, int meso) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.OPEN_STORAGE.getValue());
	mplew.write(0x16);
	mplew.writeInt(npcId);
	mplew.write(slots);
	mplew.writeShort(0x7E);
	mplew.writeShort(0);
	mplew.writeInt(0);
	mplew.writeInt(meso);
	mplew.writeShort(0);
	mplew.write((byte) items.size());
	for (IItem item : items) {
	PacketHelper.addItemInfo(mplew, item, true, true);
	}
	mplew.writeShort(0);
	mplew.write(0);

	return mplew.getPacket();
	}

	public static MaplePacket getStorageFull() {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.OPEN_STORAGE.getValue());
	mplew.write(0x11);

	return mplew.getPacket();
	}

	public static MaplePacket mesoStorage(byte slots, int meso) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.OPEN_STORAGE.getValue());
	mplew.write(0x13);
	mplew.write(slots);
	mplew.writeShort(2);
	mplew.writeShort(0);
	mplew.writeInt(0);
	mplew.writeInt(meso);

	return mplew.getPacket();
	}

	public static MaplePacket storeStorage(byte slots, MapleInventoryType type, Collection<IItem> items) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.OPEN_STORAGE.getValue());
	mplew.write(0x0D);
	mplew.write(slots);
	mplew.writeShort(type.getBitfieldEncoding());
	mplew.writeShort(0);
	mplew.writeInt(0);
	mplew.write(items.size());
	for (IItem item : items) {
	PacketHelper.addItemInfo(mplew, item, true, true);
	}
	return mplew.getPacket();
	}

	public static MaplePacket takeOutStorage(byte slots, MapleInventoryType type, Collection<IItem> items) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.OPEN_STORAGE.getValue());
	mplew.write(0x9);
	mplew.write(slots);
	mplew.writeShort(type.getBitfieldEncoding());
	mplew.writeShort(0);
	mplew.writeInt(0);
	mplew.write(items.size());
	for (IItem item : items) {
	PacketHelper.addItemInfo(mplew, item, true, true);
	}
	return mplew.getPacket();
	}

	public static MaplePacket fairyPendantMessage(int type, int percent) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.FAIRY_PEND_MSG.getValue());
	mplew.writeShort(21); // 0x15
	mplew.writeInt(0); // idk
	mplew.writeShort(0); // idk
	mplew.writeShort(percent); // percent
	mplew.writeShort(0); // idk

	return mplew.getPacket();
	}

	public static MaplePacket giveFameResponse(int mode, String charname, int newfame) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.FAME_RESPONSE.getValue());
	mplew.write(0);
	mplew.writeMapleAsciiString(charname);
	mplew.write(mode);
	mplew.writeShort(newfame);
	mplew.writeShort(0);

	return mplew.getPacket();
	}

	public static MaplePacket giveFameErrorResponse(int status) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	/*	* 0: ok, use giveFameResponse<br>
	* 1: the username is incorrectly entered<br>
	* 2: users under level 15 are unable to toggle with fame.<br>
	* 3: can't raise or drop fame anymore today.<br>
	* 4: can't raise or drop fame for this character for this month anymore.<br>
	* 5: received fame, use receiveFame()<br>
	* 6: level of fame neither has been raised nor dropped due to an unexpected error*/

	mplew.writeShort(ServerPacketOpcode.FAME_RESPONSE.getValue());
	mplew.write(status);

	return mplew.getPacket();
	}

	public static MaplePacket receiveFame(int mode, String charnameFrom) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.FAME_RESPONSE.getValue());
	mplew.write(5);
	mplew.writeMapleAsciiString(charnameFrom);
	mplew.write(mode);

	return mplew.getPacket();
	}

	public static MaplePacket partyCreated() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		mplew.write(8);
		mplew.write(0x81);
		mplew.write(0x60);
		mplew.writeShort(0);
		mplew.write(CHAR_INFO_MAGIC);
		mplew.write(CHAR_INFO_MAGIC);
		mplew.writeInt(0);
		mplew.writeInt(Randomizer.nextInt()); // random craps

		return mplew.getPacket();
	}

	public static MaplePacket partyInvite(MapleCharacter from) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		mplew.write(4);
		mplew.writeInt(from.getParty().getId());
		mplew.writeMapleAsciiString(from.getName());
		mplew.writeInt(from.getLevel());
		mplew.writeInt(from.getJob());
		mplew.write(0);

		return mplew.getPacket();
	}

	public static MaplePacket partyStatusMessage(int message) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		/*	* 10: A beginner can't create a party.
		* 1/11/14/19: Your request for a party didn't work due to an unexpected error.
		* 13: You have yet to join a party.
		* 16: Already have joined a party.
		* 17: The party you're trying to join is already in full capacity.
		* 19: Unable to find the requested character in this channel.*/
		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		mplew.write(message);

		return mplew.getPacket();
	}

	public static MaplePacket partyStatusMessage(int message, String charname) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		mplew.write(message); // 23: 'Char' have denied request to the party.
		mplew.writeMapleAsciiString(charname);

		return mplew.getPacket();
	}

	private static void addPartyStatus(int forchannel, MapleParty party, LittleEndianWriter lew, boolean leaving) {
		List<MaplePartyCharacter> partymembers = new ArrayList<MaplePartyCharacter>(party.getMembers());
		while (partymembers.size() < 6) {
			partymembers.add(new MaplePartyCharacter());
		}
		for (MaplePartyCharacter partychar : partymembers) {
			lew.writeInt(partychar.getId());
		}
		for (MaplePartyCharacter partychar : partymembers) {
			lew.writeAsciiString(StringUtil.getRightPaddedStr(partychar.getName(), '\0', 13));
		}
		for (MaplePartyCharacter partychar : partymembers) {
			lew.writeInt(partychar.getJobId());
		}
		for (MaplePartyCharacter partychar : partymembers) {
			lew.writeInt(partychar.getLevel());
		}
		for (MaplePartyCharacter partychar : partymembers) {
			if (partychar.isOnline()) {
				lew.writeInt(partychar.getChannel() - 1);
			} else {
				lew.writeInt(-2);
			}
		}
		lew.writeInt(party.getLeader().getId());
		for (MaplePartyCharacter partychar : partymembers) {
			if (partychar.getChannel() == forchannel) {
				lew.writeInt(partychar.getMapid());
			} else {
				lew.writeInt(0);
			}
		}
		for (MaplePartyCharacter partychar : partymembers) {
			if (partychar.getChannel() == forchannel && !leaving) {
				lew.writeInt(partychar.getDoorTown());
				lew.writeInt(partychar.getDoorTarget());
				lew.writeInt(2311002);
				lew.writeInt(partychar.getDoorPosition().x);
				lew.writeInt(partychar.getDoorPosition().y);
			} else {
				lew.writeInt(leaving ? 999999999 : 0);
				lew.writeLong(leaving ? 999999999 : 0);
				lew.writeLong(leaving ? -1 : 0);
			}
		}
	}

	public static MaplePacket updateParty(int forChannel, MapleParty party, PartyOperation op, MaplePartyCharacter target) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		switch (op) {
			case DISBAND:
			case EXPEL:
			case LEAVE:
			mplew.write(0xC);
			mplew.writeInt(party.getId());
			mplew.writeInt(target.getId());
			if (op == PartyOperation.DISBAND) {
				mplew.write(0);
				mplew.writeInt(target.getId());
			} else {
				mplew.write(1);
				if (op == PartyOperation.EXPEL) {
					mplew.write(1);
				} else {
					mplew.write(0);
				}
				mplew.writeMapleAsciiString(target.getName());
				addPartyStatus(forChannel, party, mplew, op == PartyOperation.LEAVE);
			}
			break;
			case JOIN:
			mplew.write(0xF);
			mplew.writeInt(24725);
			mplew.writeMapleAsciiString(target.getName());
			addPartyStatus(forChannel, party, mplew, false);
			break;
			case SILENT_UPDATE:
			case LOG_ONOFF:
			mplew.write(0x7);
			mplew.writeInt(party.getId());
			addPartyStatus(forChannel, party, mplew, op == PartyOperation.LOG_ONOFF);
			break;
			case CHANGE_LEADER:
			mplew.write(0x1F);
			mplew.writeInt(target.getId());
			mplew.write(0);
			break;
		}
		return mplew.getPacket();
	}

	public static MaplePacket partyPortal(int townId, int targetId, Point position) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.PARTY_OPERATION.getValue());
		mplew.writeShort(0x28);
		mplew.writeInt(townId);
		mplew.writeInt(targetId);
		mplew.writeInt(2311002);
		mplew.writePos(position);

		return mplew.getPacket();
	}

	public static MaplePacket updatePartyMemberHP(int cid, int curhp, int maxhp) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.UPDATE_PARTYMEMBER_HP.getValue());
		mplew.writeInt(cid);
		mplew.writeInt(curhp);
		mplew.writeInt(maxhp);

		return mplew.getPacket();
	}

	public static MaplePacket multiChat(String name, String chattext, int mode) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MULTICHAT.getValue());
		mplew.write(mode); //  0 buddychat; 1 partychat; 2 guildchat
		mplew.writeMapleAsciiString(name);
		mplew.writeMapleAsciiString(chattext);

		return mplew.getPacket();
	}

	public static MaplePacket getClock(int time) { // time in seconds
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CLOCK.getValue());
	mplew.write(2); // clock type. if you send 3 here you have to send another byte (which does not matter at all) before the timestamp
	mplew.writeInt(time);

	return mplew.getPacket();
	}

	public static MaplePacket getClockTime(int hour, int min, int sec) { // Current Time
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CLOCK.getValue());
	mplew.write(1); //Clock-Type
	mplew.write(hour);
	mplew.write(min);
	mplew.write(sec);

	return mplew.getPacket();
	}

	public static MaplePacket spawnMist(final MapleMist mist) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SPAWN_MIST.getValue());
	mplew.writeInt(mist.getObjectId());
	mplew.writeInt(mist.isMobMist() ? 0 : mist.isPoisonMist() ? 1 : 2);

	if (mist.getOwner() != null) {
	mplew.writeInt(mist.getOwner().getId());
	mplew.writeInt(mist.getSourceSkill().getId());
	mplew.write(mist.getSkillLevel());
	} else {
	mplew.writeInt(mist.getMobOwner().getId());
	mplew.writeInt(mist.getMobSkill().getSkillId());
	mplew.write(mist.getMobSkill().getSkillLevel());
	}
	mplew.writeShort(mist.getSkillDelay());
	mplew.writeInt(mist.getBox().x);
	mplew.writeInt(mist.getBox().y);
	mplew.writeInt(mist.getBox().x + mist.getBox().width);
	mplew.writeInt(mist.getBox().y + mist.getBox().height);
	mplew.writeInt(0);

	return mplew.getPacket();
	}

	public static MaplePacket removeMist(final int oid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REMOVE_MIST.getValue());
	mplew.writeInt(oid);

	return mplew.getPacket();
	}

	public static MaplePacket damageSummon(int cid, int summonSkillId, int damage, int unkByte, int monsterIdFrom) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.DAMAGE_SUMMON.getValue());
	mplew.writeInt(cid);
	mplew.writeInt(summonSkillId);
	mplew.write(unkByte);
	mplew.writeInt(damage);
	mplew.writeInt(monsterIdFrom);
	mplew.write(0);

	return mplew.getPacket();
	}

	public static MaplePacket buddylistMessage(byte message) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.BUDDYLIST.getValue());
	mplew.write(message);

	return mplew.getPacket();
	}

	public static MaplePacket updateBuddylist(Collection<BuddylistEntry> buddylist) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.BUDDYLIST.getValue());
	mplew.write(7);
	mplew.write(buddylist.size());

	for (BuddylistEntry buddy : buddylist) {
	if (buddy.isVisible()) {
	mplew.writeInt(buddy.getCharacterId());
	mplew.writeAsciiString(StringUtil.getRightPaddedStr(buddy.getName(), '\0', 13));
	mplew.write(0);
	mplew.writeInt(buddy.getChannel() == -1 ? -1 : buddy.getChannel() - 1);
	mplew.writeAsciiString(StringUtil.getRightPaddedStr(buddy.getGroup(), '\0', 17));
	}
	}
	for (int x = 0; x < buddylist.size(); x++) {
	mplew.writeInt(0);
	}
	return mplew.getPacket();
	}

	public static MaplePacket requestBuddylistAdd(int cidFrom, String nameFrom, int levelFrom, int jobFrom) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.BUDDYLIST.getValue());
	mplew.write(9);
	mplew.writeInt(cidFrom);
	mplew.writeMapleAsciiString(nameFrom);
	mplew.writeInt(levelFrom);
	mplew.writeInt(jobFrom);
	mplew.writeInt(cidFrom);
	mplew.writeAsciiString(StringUtil.getRightPaddedStr(nameFrom, '\0', 13));
	mplew.write(1);
	mplew.writeInt(0);
	mplew.write(HexTool.getByteArrayFromHexString("44 65 66 61 75 6C 74 20 47 72 6F 75 70 00 6E 67")); // default group
	mplew.writeShort(1);

	return mplew.getPacket();
	}

	public static MaplePacket updateBuddyChannel(int characterid, int channel) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.BUDDYLIST.getValue());
	mplew.write(0x14);
	mplew.writeInt(characterid);
	mplew.write(0);
	mplew.writeInt(channel);

	return mplew.getPacket();
	}

	public static MaplePacket itemEffect(int characterid, int itemid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_EFFECT.getValue());
	mplew.writeInt(characterid);
	mplew.writeInt(itemid);

	return mplew.getPacket();
	}

	public static MaplePacket updateBuddyCapacity(int capacity) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.BUDDYLIST.getValue());
	mplew.write(0x15);
	mplew.write(capacity);

	return mplew.getPacket();
	}

	public static MaplePacket showChair(int characterid, int itemid) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.SHOW_CHAIR.getValue());
	mplew.writeInt(characterid);
	mplew.writeInt(itemid);

	return mplew.getPacket();
	}

	public static MaplePacket cancelChair(int id) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.CANCEL_CHAIR.getValue());
	if (id == -1) {
	mplew.write(0);
	} else {
	mplew.write(1);
	mplew.writeShort(id);
	}
	return mplew.getPacket();
	}

	public static MaplePacket spawnReactor(MapleReactor reactor) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REACTOR_SPAWN.getValue());
	mplew.writeInt(reactor.getObjectId());
	mplew.writeInt(reactor.getReactorId());
	mplew.write(reactor.getState());
	mplew.writePos(reactor.getPosition());
	mplew.write(reactor.getFacingDirection()); // stance
	mplew.writeShort(0);

	return mplew.getPacket();
	}

	public static MaplePacket triggerReactor(MapleReactor reactor, int stance) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REACTOR_HIT.getValue());
	mplew.writeInt(reactor.getObjectId());
	mplew.write(reactor.getState());
	mplew.writePos(reactor.getPosition());
	mplew.writeShort(stance);
	mplew.write(0);
	mplew.write(4); // frame delay, set to 5 since there doesn't appear to be a fixed formula for it

	return mplew.getPacket();
	}

	public static MaplePacket destroyReactor(MapleReactor reactor) {
	MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

	mplew.writeShort(ServerPacketOpcode.REACTOR_DESTROY.getValue());
	mplew.writeInt(reactor.getObjectId());
	mplew.write(reactor.getState());
	mplew.writePos(reactor.getPosition());

	return mplew.getPacket();
	}

	public static MaplePacket musicChange(String song) {
	return environmentChange(song, 6);
	}

	public static MaplePacket showEffect(String effect) {
	return environmentChange(effect, 3);
	}

	public static MaplePacket playSound(String sound) {
	return environmentChange(sound, 4);
	}

	public static MaplePacket environmentChange(String env, int mode) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.BOSS_ENV.getValue());
		mplew.write(mode);
		mplew.writeMapleAsciiString(env);

		return mplew.getPacket();
	}

	public static MaplePacket startMapEffect(String msg, int itemid, boolean active) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MAP_EFFECT.getValue());
		mplew.write(active ? 0 : 1);
		mplew.writeInt(itemid);
		if (active) {
			mplew.writeMapleAsciiString(msg);
		}
		return mplew.getPacket();
	}

	public static MaplePacket removeMapEffect() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MAP_EFFECT.getValue());
		mplew.write(0);
		mplew.writeInt(0);

		return mplew.getPacket();
	}

	public static MaplePacket showGuildInfo(MapleCharacter c) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x1A); //signature for showing guild info

		if (c == null) { //show empty guild (used for leaving, expelled)
		mplew.write(0);
		return mplew.getPacket();
		}
		MapleGuildCharacter initiator = c.getMGC();
		MapleGuild g = c.getClient().getChannelServer().getGuild(initiator);
		if (g == null) { //failed to read from DB - don't show a guild
		mplew.write(0);
		return mplew.getPacket();
		} else {
		//MapleGuild holds the absolute correct value of guild rank after it is initiated
		MapleGuildCharacter mgc = g.getMGC(c.getId());
		c.setGuildRank(mgc.getGuildRank());
		}
		mplew.write(1); //bInGuild
		mplew.writeInt(c.getGuildId()); //not entirely sure about this one
		mplew.writeMapleAsciiString(g.getName());
		for (int i = 1; i <= 5; i++) {
		mplew.writeMapleAsciiString(g.getRankTitle(i));
		}
		g.addMemberData(mplew);

		mplew.writeInt(g.getCapacity());
		mplew.writeShort(g.getLogoBG());
		mplew.write(g.getLogoBGColor());
		mplew.writeShort(g.getLogo());
		mplew.write(g.getLogoColor());
		mplew.writeMapleAsciiString(g.getNotice());
		mplew.writeInt(g.getGP());
		mplew.writeInt(0);

		return mplew.getPacket();
	}

	public static MaplePacket guildMemberOnline(int gid, int cid, boolean bOnline) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x3d);
		mplew.writeInt(gid);
		mplew.writeInt(cid);
		mplew.write(bOnline ? 1 : 0);

		return mplew.getPacket();
	}

	public static MaplePacket guildInvite(int gid, String charName, int levelFrom, int jobFrom) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x05);
		mplew.writeInt(gid);
		mplew.writeMapleAsciiString(charName);
		mplew.writeInt(levelFrom);
		mplew.writeInt(jobFrom);

		return mplew.getPacket();
	}

	public static MaplePacket denyGuildInvitation(String charname) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x37);
		mplew.writeMapleAsciiString(charname);

		return mplew.getPacket();
	}

	public static MaplePacket genericGuildMessage(byte code) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(code);

		return mplew.getPacket();
	}

	public static MaplePacket newGuildMember(MapleGuildCharacter mgc) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x27);
		mplew.writeInt(mgc.getGuildId());
		mplew.writeInt(mgc.getId());
		mplew.writeAsciiString(StringUtil.getRightPaddedStr(mgc.getName(), '\0', 13));
		mplew.writeInt(mgc.getJobId());
		mplew.writeInt(mgc.getLevel());
		mplew.writeInt(mgc.getGuildRank()); //should be always 5 but whatevs
		mplew.writeInt(mgc.isOnline() ? 1 : 0); //should always be 1 too
		mplew.writeInt(1); //? could be guild signature, but doesn't seem to matter
		mplew.writeInt(3);

		return mplew.getPacket();
	}

	//someone leaving, mode == 0x2c for leaving, 0x2f for expelled
	public static MaplePacket memberLeft(MapleGuildCharacter mgc, boolean bExpelled) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(bExpelled ? 0x2f : 0x2c);

		mplew.writeInt(mgc.getGuildId());
		mplew.writeInt(mgc.getId());
		mplew.writeMapleAsciiString(mgc.getName());

		return mplew.getPacket();
	}

	public static MaplePacket changeRank(MapleGuildCharacter mgc) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x40);
		mplew.writeInt(mgc.getGuildId());
		mplew.writeInt(mgc.getId());
		mplew.write(mgc.getGuildRank());

		return mplew.getPacket();
	}

	public static MaplePacket guildNotice(int gid, String notice) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x44);
		mplew.writeInt(gid);
		mplew.writeMapleAsciiString(notice);

		return mplew.getPacket();
	}

	public static MaplePacket guildMemberLevelJobUpdate(MapleGuildCharacter mgc) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x3C);
		mplew.writeInt(mgc.getGuildId());
		mplew.writeInt(mgc.getId());
		mplew.writeInt(mgc.getLevel());
		mplew.writeInt(mgc.getJobId());

		return mplew.getPacket();
	}

	public static MaplePacket rankTitleChange(int gid, String[] ranks) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x3e);
		mplew.writeInt(gid);
		for (String r : ranks) {
			mplew.writeMapleAsciiString(r);
		}

		return mplew.getPacket();
	}

	public static MaplePacket guildDisband(int gid) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x32);
		mplew.writeInt(gid);
		mplew.write(1);

		return mplew.getPacket();
	}

	public static MaplePacket guildEmblemChange(int gid, short bg, byte bgcolor, short logo, byte logocolor) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x42);
		mplew.writeInt(gid);
		mplew.writeShort(bg);
		mplew.write(bgcolor);
		mplew.writeShort(logo);
		mplew.write(logocolor);

		return mplew.getPacket();
	}

	public static MaplePacket guildCapacityChange(int gid, int capacity) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x3a);
		mplew.writeInt(gid);
		mplew.write(capacity);

		return mplew.getPacket();
	}

	public static MaplePacket showAllianceInfo(MapleCharacter chr) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ALLIANCE_OPERATION.getValue());
		mplew.write(0x0C);
		MapleAlliance alliance = chr.getGuild().getAlliance(chr.getClient());
		if (alliance == null) { //show empty alliance (used for leaving, expelled)
			mplew.write(0);
			return mplew.getPacket();
		}
		mplew.write(1); //Only happens if you are in an alliance
		mplew.writeInt(alliance.getId());
		mplew.writeMapleAsciiString(alliance.getName()); // alliance name
		for (int i = 0; i < 5; i++) {
			mplew.writeMapleAsciiString(alliance.getTitles()[i]);
		}
		mplew.write(alliance.getAmountOfGuilds());//ammount of guilds joined
		for (int z = 0; z < 5; z++) {
			if (alliance.getGuilds().get(z) != null) {
				mplew.writeInt(alliance.getGuilds().get(z).getId());
			}
		}
		mplew.writeInt(3);//3..
		mplew.writeMapleAsciiString(alliance.getNotice());

		return mplew.getPacket();
	}

	public static MaplePacket createAlliance(String name) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ALLIANCE_OPERATION.getValue());
		mplew.write(0x0F);

		return mplew.getPacket();
	}

	public static MaplePacket showAllianceMembers(MapleCharacter chr) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();
		mplew.writeShort(ServerPacketOpcode.ALLIANCE_OPERATION.getValue());
		mplew.write(0x0D);
		MapleAlliance az = chr.getGuild().getAlliance(chr.getClient());
		int e = 0;
		for (int u = 0; u < 5; u++) {
			if (az.getGuilds().get(u) != null) {
				e++;
			}
		}
		mplew.writeInt(e);//ammount of guilds joined
		chr.setGuildRank(chr.getGuild().getMGC(chr.getId()).getGuildRank());
		for (int i = 0; i < 5; i++) {
			MapleGuild g = az.getGuilds().get(i);
			if (g != null) {
				mplew.writeInt(g.getId());
				mplew.writeMapleAsciiString(g.getName());
				for (int a = 1; a <= 5; a++) {
					mplew.writeMapleAsciiString(g.getRankTitle(a));
				}
				g.addMemberData(mplew);
				mplew.writeInt(g.getCapacity());
				mplew.writeShort(g.getLogoBG());
				mplew.write(g.getLogoBGColor());
				mplew.writeShort(g.getLogo());
				mplew.write(g.getLogoColor());
				mplew.writeMapleAsciiString(g.getNotice());
				mplew.writeInt(g.getGP());
				mplew.write(HexTool.getByteArrayFromHexString("0F 03 00 00"));
			}
		}
		return mplew.getPacket();
	}

	public static MaplePacket BBSThreadList(ResultSet rs, int start) throws SQLException {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.BBS_OPERATION.getValue());
		mplew.write(6);
		int threadCount = rs.getRow();
		if (!rs.last()) {
			mplew.write(0);
		} else if (rs.getInt("localthreadid") == 0) { //has a notice
			mplew.write(1);
			addThread(mplew, rs);
			threadCount--; //one thread didn't count (because it's a notice)
		} else {
			mplew.write(0);
		}
		if (!rs.absolute(start + 1)) { //seek to the thread before where we start
			rs.first(); //uh, we're trying to start at a place past possible
			start = 0;
		}
		mplew.writeInt(threadCount);
		mplew.writeInt(Math.min(10, threadCount - start));
		for (int i = 0; i < Math.min(10, threadCount - start); i++) {
			addThread(mplew, rs);
			rs.next();
		}

		return mplew.getPacket();
	}

	private static void addThread(MaplePacketLittleEndianWriter mplew, ResultSet rs) throws SQLException {
		mplew.writeInt(rs.getInt("localthreadid"));
		mplew.writeInt(rs.getInt("postercid"));
		mplew.writeMapleAsciiString(rs.getString("name"));
		mplew.writeLong(PacketHelper.getKoreanTimestamp(rs.getLong("timestamp")));
		mplew.writeInt(rs.getInt("icon"));
		mplew.writeInt(rs.getInt("replycount"));
	}

	public static MaplePacket showThread(int localthreadid, ResultSet threadRS, ResultSet repliesRS) throws SQLException, RuntimeException {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.BBS_OPERATION.getValue());
		mplew.write(7);
		mplew.writeInt(localthreadid);
		mplew.writeInt(threadRS.getInt("postercid"));
		mplew.writeLong(PacketHelper.getKoreanTimestamp(threadRS.getLong("timestamp")));
		mplew.writeMapleAsciiString(threadRS.getString("name"));
		mplew.writeMapleAsciiString(threadRS.getString("startpost"));
		mplew.writeInt(threadRS.getInt("icon"));
		if (repliesRS != null) {
			int replyCount = threadRS.getInt("replycount");
			mplew.writeInt(replyCount);
			int i;
			for (i = 0; i < replyCount && repliesRS.next(); i++) {
				mplew.writeInt(repliesRS.getInt("replyid"));
				mplew.writeInt(repliesRS.getInt("postercid"));
				mplew.writeLong(PacketHelper.getKoreanTimestamp(repliesRS.getLong("timestamp")));
				mplew.writeMapleAsciiString(repliesRS.getString("content"));
			}
			if (i != replyCount || repliesRS.next()) {
				//in the unlikely event that we lost count of replyid
				throw new RuntimeException(String.valueOf(threadRS.getInt("threadid")));
				/*we need to fix the database and stop the packet sending
				or else it'll probably error 38 whoever tries to read it
				there is ONE case not checked, and that's when the thread
				has a replycount of 0 and there is one or more replies to the
				thread in bbs_replies*/
			}
		} else {
			mplew.writeInt(0); //0 replies
		}
		return mplew.getPacket();
	}

	public static MaplePacket showGuildRanks(int npcid, List<GuildRankingInfo> all) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x49);
		mplew.writeInt(npcid);
		mplew.writeInt(all.size());
		for (GuildRankingInfo info : all) {
			mplew.writeMapleAsciiString(info.getName());
			mplew.writeInt(info.getGP());
			mplew.writeInt(info.getLogo());
			mplew.writeInt(info.getLogoBg());
			mplew.writeInt(info.getLogoBgColor());
			mplew.writeInt(info.getLogoColor());
		}

		return mplew.getPacket();
	}

	public static MaplePacket updateGP(int gid, int GP) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.GUILD_OPERATION.getValue());
		mplew.write(0x48);
		mplew.writeInt(gid);
		mplew.writeInt(GP);

		return mplew.getPacket();
	}

	public static MaplePacket skillEffect(MapleCharacter from, int skillId, byte level, byte flags, byte speed, byte unk) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SKILL_EFFECT.getValue());
		mplew.writeInt(from.getId());
		mplew.writeInt(skillId);
		mplew.write(level);
		mplew.write(flags);
		mplew.write(speed);
		mplew.write(unk); // Direction ??

		return mplew.getPacket();
	}

	public static MaplePacket skillCancel(MapleCharacter from, int skillId) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CANCEL_SKILL_EFFECT.getValue());
		mplew.writeInt(from.getId());
		mplew.writeInt(skillId);

		return mplew.getPacket();
	}

	public static MaplePacket showMagnet(int mobid, byte success) { // Monster Magnet
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_MAGNET.getValue());
		mplew.writeInt(mobid);
		mplew.write(success);

		return mplew.getPacket();
	}

	public static MaplePacket sendHint(String hint, int width, int height) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		if (width < 1) {
			width = hint.length() * 10;
			if (width < 40) {
				width = 40;
			}
		}
		if (height < 5) {
			height = 5;
		}
		mplew.writeShort(ServerPacketOpcode.PLAYER_HINT.getValue());
		mplew.writeMapleAsciiString(hint);
		mplew.writeShort(width);
		mplew.writeShort(height);
		mplew.write(1);

		return mplew.getPacket();
	}

	public static MaplePacket messengerInvite(String from, int messengerid) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x03);
		mplew.writeMapleAsciiString(from);
		mplew.write(0x00);
		mplew.writeInt(messengerid);
		mplew.write(0x00);

		return mplew.getPacket();
	}

	public static MaplePacket addMessengerPlayer(String from, MapleCharacter chr, int position, int channel) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x00);
		mplew.write(position);
		PacketHelper.addCharLook(mplew, chr, true);
		mplew.writeMapleAsciiString(from);
		mplew.write(channel);
		mplew.write(0x00);

		return mplew.getPacket();
	}

	public static MaplePacket removeMessengerPlayer(int position) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x02);
		mplew.write(position);

		return mplew.getPacket();
	}

	public static MaplePacket updateMessengerPlayer(String from, MapleCharacter chr, int position, int channel) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x07);
		mplew.write(position);
		PacketHelper.addCharLook(mplew, chr, true);
		mplew.writeMapleAsciiString(from);
		mplew.write(channel);
		mplew.write(0x00);

		return mplew.getPacket();
	}

	public static MaplePacket joinMessenger(int position) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x01);
		mplew.write(position);

		return mplew.getPacket();
	}

	public static MaplePacket messengerChat(String text) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(0x06);
		mplew.writeMapleAsciiString(text);

		return mplew.getPacket();
	}

	public static MaplePacket messengerNote(String text, int mode, int mode2) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.MESSENGER.getValue());
		mplew.write(mode);
		mplew.writeMapleAsciiString(text);
		mplew.write(mode2);

		return mplew.getPacket();
	}

	public static MaplePacket getFindReplyWithCS(String target) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.WHISPER.getValue());
		mplew.write(9);
		mplew.writeMapleAsciiString(target);
		mplew.write(2);
		mplew.writeInt(-1);

		return mplew.getPacket();
	}

	public static MaplePacket showEquipEffect() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_EQUIP_EFFECT.getValue());

		return mplew.getPacket();
	}

	public static MaplePacket summonSkill(int cid, int summonSkillId, int newStance) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SUMMON_SKILL.getValue());
		mplew.writeInt(cid);
		mplew.writeInt(summonSkillId);
		mplew.write(newStance);

		return mplew.getPacket();
	}

	public static MaplePacket skillCooldown(int sid, int time) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.COOLDOWN.getValue());
		mplew.writeInt(sid);
		mplew.writeShort(time);

		return mplew.getPacket();
	}

	public static MaplePacket useSkillBook(MapleCharacter chr, int skillid, int maxlevel, boolean canuse, boolean success) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.USE_SKILL_BOOK.getValue());
		mplew.writeInt(chr.getId());
		mplew.write(1);
		mplew.writeInt(skillid);
		mplew.writeInt(maxlevel);
		mplew.write(canuse ? 1 : 0);
		mplew.write(success ? 1 : 0);

		return mplew.getPacket();
	}

	public static MaplePacket getMacros(SkillMacro[] macros) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SKILL_MACRO.getValue());
		int count = 0;
		for (int i = 0; i < 5; i++) {
			if (macros[i] != null) {
				count++;
			}
		}
		mplew.write(count); // number of macros
		for (int i = 0; i < 5; i++) {
			SkillMacro macro = macros[i];
			if (macro != null) {
				mplew.writeMapleAsciiString(macro.getName());
				mplew.write(macro.getShout());
				mplew.writeInt(macro.getSkill1());
				mplew.writeInt(macro.getSkill2());
				mplew.writeInt(macro.getSkill3());
			}
		}

		return mplew.getPacket();
	}

	public static MaplePacket updateAriantPQRanking(String name, int score, boolean empty) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ARIANT_PQ_START.getValue());
		mplew.write(empty ? 0 : 1);
		if (!empty) {
		mplew.writeMapleAsciiString(name);
		mplew.writeInt(score);
		}
		return mplew.getPacket();
	}

	public static MaplePacket catchMonster(int mobid, int itemid, byte success) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CATCH_MONSTER.getValue());
		mplew.writeInt(mobid);
		mplew.writeInt(itemid);
		mplew.write(success);

		return mplew.getPacket();
	}

	public static MaplePacket showAriantScoreBoard() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ARIANT_SCOREBOARD.getValue());

		return mplew.getPacket();
	}

	public static MaplePacket showZakumShrineTimeLeft(int timeleft) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ZAKUM_SHRINE.getValue());
		mplew.write(0);
		mplew.writeInt(timeleft);

		return mplew.getPacket();
	}

	public static MaplePacket boatPacket(int effect) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		// 1034: balrog boat comes, 1548: boat comes, 3: boat leaves
		mplew.writeShort(ServerPacketOpcode.BOAT_EFFECT.getValue());
		mplew.writeShort(effect); // 0A 04 balrog

		return mplew.getPacket();
	}

	public static MaplePacket removeItemFromDuey(boolean remove, int Package) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DUEY.getValue());
		mplew.write(0x18);
		mplew.writeInt(Package);
		mplew.write(remove ? 3 : 4);

		return mplew.getPacket();
	}

	public static MaplePacket sendDuey(byte operation, List<MapleDueyActions> packages) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DUEY.getValue());
		mplew.write(operation);
		switch (operation) {
			case 9: { // Request 13 Digit AS
				mplew.write(1);
				// 0xFF = error
				break;
			}
			case 10: { // Open duey
				mplew.write(0);
				mplew.write(packages.size());
				for (MapleDueyActions dp : packages) {
					mplew.writeInt(dp.getPackageId());
					mplew.writeAsciiString(dp.getSender(), 13);
					mplew.writeInt(dp.getMesos());
					mplew.writeLong(KoreanDateUtil.getFileTimestamp(dp.getSentTime(), false));
					mplew.write(0);
					mplew.writeZeroBytes(51 * 4);
					if (dp.getItem() != null) {
						mplew.write(1);
						PacketHelper.addItemInfo(mplew, dp.getItem(), true, true);
					} else {
						mplew.write(0);
					}
				}
				mplew.write(0);
				break;
			}
		}
		
		return mplew.getPacket();
	}

	public static MaplePacket enableTV() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ENABLE_TV.getValue());
		mplew.writeInt(0);
		mplew.write(0);

		return mplew.getPacket();
	}

	public static MaplePacket removeTV() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.REMOVE_TV.getValue());

		return mplew.getPacket();
	}

	public static MaplePacket sendTV(MapleCharacter chr, List<String> messages, int type, MapleCharacter partner) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SEND_TV.getValue());
		mplew.write(partner != null ? 2 : 0);
		mplew.write(type); // type   Heart = 2  Star = 1  Normal = 0
		PacketHelper.addCharLook(mplew, chr, false);
		mplew.writeMapleAsciiString(chr.getName());
		if (partner != null) {
			mplew.writeMapleAsciiString(partner.getName());
		} else {
			mplew.writeShort(0);
		}
		for (int i = 0; i < messages.size(); i++) {
			if (i == 4 && messages.get(4).length() > 15) {
				mplew.writeMapleAsciiString(messages.get(4).substring(0, 15)); // hmm ?
			} else {
				mplew.writeMapleAsciiString(messages.get(i));
			}
		}
		mplew.writeInt(1337); // time limit shit lol 'Your thing still start in blah blah seconds'
		if (partner != null) {
			PacketHelper.addCharLook(mplew, partner, false);
		}

		return mplew.getPacket();
	}

	public static MaplePacket Mulung_DojoUp() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
		mplew.write(0x0B);
		mplew.writeShort(1207); // ???
		mplew.writeMapleAsciiString("pt=5599;min=4;belt=3;tuto=1"); // todo

		return mplew.getPacket();
	}

	public static MaplePacket Mulung_DojoUp2() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_ITEM_GAIN_INCHAT.getValue());
		mplew.write(7);

		return mplew.getPacket();
	}

	public static MaplePacket spawnDragon(MapleDragon d) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DRAGON_SPAWN.getValue());
		mplew.writeInt(d.getOwner());
		mplew.writeInt(d.getPosition().x);
		mplew.writeInt(d.getPosition().y);
		mplew.write(d.getStance()); //stance?
		mplew.writeShort(0);
		mplew.writeShort(d.getJobId());

		return mplew.getPacket();
	}

	public static MaplePacket removeDragon(int chrid) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DRAGON_REMOVE.getValue());
		mplew.writeInt(chrid);

		return mplew.getPacket();
	}

	public static MaplePacket moveDragon(MapleDragon d, Point startPos, List<LifeMovementFragment> moves) {
		final MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.DRAGON_MOVE.getValue()); //not sure
		mplew.writeInt(d.getOwner());
		mplew.writePos(startPos);
		mplew.writeInt(0);
		PacketHelper.serializeMovementList(mplew, moves);

		return mplew.getPacket();
	}

	public static MaplePacket Mulung_Pts(int recv, int total) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.SHOW_STATUS_INFO.getValue());
		mplew.write(10);
		mplew.writeMapleAsciiString("You have received " + recv + " training points, for the accumulated total of " + total + " training points.");

		return mplew.getPacket();
	}

	public static MaplePacket MulungEnergy(int energy) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ENERGY.getValue());
		mplew.writeMapleAsciiString("energy");
		mplew.writeMapleAsciiString(String.valueOf(energy));

		return mplew.getPacket();
	}

	public static MaplePacket PyramidEnergy(byte type, int amount) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.ENERGY.getValue());
		mplew.writeMapleAsciiString("massacre_" + (type == 0 ? "cool" : type == 1 ? "kill" : "miss"));
		mplew.writeMapleAsciiString(Integer.toString(amount));
//mc.getClient().getSession().write(MaplePacketCreator.updatePyramidInfo(1, mc.getInstance(PartyQuest.NETT_PYRAMID).gainReturnKills());  
		return mplew.getPacket();
	}

	public static MaplePacket cancelHoming() {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.CANCEL_BUFF.getValue());
		mplew.writeLong(MapleBuffStat.HOMING_BEACON.getValue());
		mplew.writeLong(0);

		return mplew.getPacket();
	}

	public static MaplePacket sendMapleTip(String message) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(0x46); // Header
		mplew.write(0xFF);
		mplew.writeMapleAsciiString(message);

		return mplew.getPacket();
	}

	public static MaplePacket finishedSort(int type) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.FINISH_SORT.getValue());
		mplew.write(0);
		mplew.write(type);

		return mplew.getPacket();
	}

	public static MaplePacket finishedSort2(int type) {
		MaplePacketLittleEndianWriter mplew = new MaplePacketLittleEndianWriter();

		mplew.writeShort(ServerPacketOpcode.FINISH_GATHER.getValue());
		mplew.write(0);
		mplew.write(type);

		return mplew.getPacket();
	}
}